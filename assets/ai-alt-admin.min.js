!function(e){"use strict";var t=window.AI_ALT_GPT_DASH||window.AI_ALT_GPT||{};function a(a){a.preventDefault();var n=e(this),o=n.text();if(n.prop("disabled"))return!1;n.prop("disabled",!0),n.text("Loading..."),e.ajax({url:t.restMissing||t.restRoot+"ai-alt/v1/list?scope=missing",method:"GET",headers:{"X-WP-Nonce":t.nonce},data:{limit:500}}).done(function(e){if(!e||!e.ids||0===e.ids.length)return alert("No images found that need alt text."),n.prop("disabled",!1),void n.text(o);var t=e.ids||[],a=t.length;r("Preparing bulk run...",a,0),i(t,"bulk",function(e,s,d){if(n.prop("disabled",!1),n.text(o),e&&s>0)l(),alert("Successfully queued "+s+" image"+(1!==s?"s":"")+" for alt text generation. Processing will start shortly."),setTimeout(function(){window.location.reload()},2e3);else if(e&&0===s)l(),alert("All images are already in queue or processing. Please check the queue status."),setTimeout(function(){window.location.reload()},1e3);else{if(l(),d&&d.code&&console.error("[AI Alt Text] Error:",d.code,d.message||"Unknown error"),d&&"insufficient_credits"===d.code&&null!==d.remaining&&d.remaining>0){var u=d.remaining,c=a,g=d.message||"You only have "+u+" generations remaining.";if(confirm(g+"\n\nWould you like to generate "+u+" image"+(1!==u?"s":"")+" now using your remaining "+u+" credit"+(1!==u?"s":"")+'?\n\n(Click "OK" to generate now, or "Cancel" to upgrade)')){var f=t.slice(0,u);return n.prop("disabled",!0),n.text("Loading..."),r("Queueing "+u+" image"+(1!==u?"s":"")+"...",u,0),void i(f,"bulk",function(e,t,a){if(n.prop("disabled",!1),n.text(o),e&&t>0)l(),alert("Successfully queued "+t+" image"+(1!==t?"s":"")+" for alt text generation. Processing will start shortly."),setTimeout(function(){window.location.reload()},2e3);else{l();var i="Failed to queue images.";a&&a.message&&(i=a.message),alert(i)}})}if(confirm("Would you like to upgrade to get more credits and generate all "+c+" image"+(1!==c?"s":"")+"?"))if("function"==typeof alttextaiShowModal)alttextaiShowModal();else if(void 0!==window.alttextai_ajax&&window.alttextai_ajax.is_authenticated){var m=document.querySelector('[data-action="show-upgrade-modal"]');m&&m.click()}else"function"==typeof showAuthLogin&&showAuthLogin();return}g="Failed to queue images.",d&&d.message?g=d.message:g+=a>0?" Please check your browser console for details and try again.":" No images were found to queue.",d&&d.message?console.error("[AI Alt Text] Error details:",d):console.error("[AI Alt Text] Queue failed for generate missing - no error details"),alert(g)}})}).fail(function(e,t,a){console.error("[AI Alt Text] Failed to get missing images:",a,e),n.prop("disabled",!1),n.text(o),alert("Failed to load images. Please try again."),l()})}function n(a){if(a.preventDefault(),!confirm("This will regenerate alt text for ALL images, replacing existing alt text. Are you sure?"))return!1;var n=e(this),o=n.text();if(n.prop("disabled"))return!1;n.prop("disabled",!0),n.text("Loading..."),e.ajax({url:t.restAll||t.restRoot+"ai-alt/v1/list?scope=all",method:"GET",headers:{"X-WP-Nonce":t.nonce},data:{limit:500}}).done(function(e){if(!e||!e.ids||0===e.ids.length)return alert("No images found."),n.prop("disabled",!1),void n.text(o);var t=e.ids||[],a=t.length;r("Preparing bulk regeneration...",a,0),i(t,"bulk-regenerate",function(e,s,d){if(n.prop("disabled",!1),n.text(o),e&&s>0)l(),alert("Successfully queued "+s+" image"+(1!==s?"s":"")+" for alt text regeneration. Processing will start shortly."),setTimeout(function(){window.location.reload()},2e3);else if(e&&0===s)l(),alert("All images are already in queue or processing. Please check the queue status."),setTimeout(function(){window.location.reload()},1e3);else{if(l(),d&&d.code&&console.error("[AI Alt Text] Error:",d.code,d.message||"Unknown error"),d&&"insufficient_credits"===d.code&&null!==d.remaining&&d.remaining>0){var u=d.remaining,c=a,g=d.message||"You only have "+u+" generations remaining.";if(confirm(g+"\n\nWould you like to regenerate "+u+" image"+(1!==u?"s":"")+" now using your remaining "+u+" credit"+(1!==u?"s":"")+'?\n\n(Click "OK" to regenerate now, or "Cancel" to upgrade)')){var f=t.slice(0,u);return n.prop("disabled",!0),n.text("Loading..."),r("Queueing "+u+" image"+(1!==u?"s":"")+" for regeneration...",u,0),void i(f,"bulk-regenerate",function(e,t,a){if(n.prop("disabled",!1),n.text(o),e&&t>0)l(),alert("Successfully queued "+t+" image"+(1!==t?"s":"")+" for alt text regeneration. Processing will start shortly."),setTimeout(function(){window.location.reload()},2e3);else{l();var i="Failed to queue images.";a&&a.message&&(i=a.message),alert(i)}})}if(confirm("Would you like to upgrade to get more credits and regenerate all "+c+" image"+(1!==c?"s":"")+"?"))if("function"==typeof alttextaiShowModal)alttextaiShowModal();else if(void 0!==window.alttextai_ajax&&window.alttextai_ajax.is_authenticated){var m=document.querySelector('[data-action="show-upgrade-modal"]');m&&m.click()}else"function"==typeof showAuthLogin&&showAuthLogin();return}g="Failed to queue images.",d&&d.message?g=d.message:g+=a>0?" Please check your browser console for details and try again.":" No images were found to queue.",d&&d.message?console.error("[AI Alt Text] Error details:",d):console.error("[AI Alt Text] Queue failed for regenerate all - no error details"),alert(g)}})}).fail(function(e,t,a){console.error("[AI Alt Text] Failed to get all images:",a,e),n.prop("disabled",!1),n.text(o),alert("Failed to load images. Please try again."),l()})}function o(a){a.preventDefault();var n=e(this),o=n.data("attachment-id");if(!o||n.prop("disabled"))return!1;var i=n.text();n.prop("disabled",!0),n.text("Generating...");var r=window.alttextai_ajax&&window.alttextai_ajax.ajax_url||("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php"),s=window.alttextai_ajax&&window.alttextai_ajax.nonce||t.nonce;e.ajax({url:r,method:"POST",data:{action:"alttextai_regenerate_single",attachment_id:o,nonce:s}}).done(function(e){if(n.prop("disabled",!1),n.text(i),e&&e.success){var t=n.closest("tr").find(".alttextai-table__cell--alt");t.length&&e.data&&e.data.alt_text&&t.text(e.data.alt_text),d("Alt text regenerated successfully!","success"),"function"==typeof refreshUsageStats&&refreshUsageStats()}else d(e&&e.data&&e.data.message||"Failed to regenerate alt text","error")}).fail(function(e,t,a){console.error("[AI Alt Text] Failed to regenerate:",a,e),n.prop("disabled",!1),n.text(i);var o="Failed to regenerate alt text";e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message&&(o=e.responseJSON.data.message),d(o,"error")})}function i(a,n,o){if(a&&0!==a.length){a.length;var i=0,r=window.alttextai_ajax&&window.alttextai_ajax.ajax_url||("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php"),l=window.alttextai_ajax&&window.alttextai_ajax.nonce||t.nonce;e.ajax({url:r,method:"POST",data:{action:"alttextai_bulk_queue",attachment_ids:a,source:n||"bulk",nonce:l},dataType:"json"}).done(function(e){if(e&&e.success){var t=e.data||{};(i=t.queued||0)>0||console.warn("[AI Alt Text] No images were queued. Response:",e),o(!0,i,null)}else{var a="Failed to queue images",n=null,r=null;e&&e.data&&"object"==typeof e.data&&null!==e.data&&(e.data.message&&(a=e.data.message),e.data.code&&(n=e.data.code),void 0!==e.data.remaining&&null!==e.data.remaining&&(r=parseInt(e.data.remaining,10))),console.error("[AI Alt Text] Queue failed:",a,n?"(Code: "+n+")":""),o(!1,0,{message:a,code:n,remaining:r})}}).fail(function(n,i,r){console.error("[AI Alt Text] AJAX request failed:",{status:i,error:r,xhr:n,responseText:n.responseText,statusCode:n.status});var l=null;try{var d=JSON.parse(n.responseText);d&&d.data&&(l={message:d.data.message||"Failed to queue images",code:d.data.code||null,remaining:d.data.remaining||null})}catch(e){}if(403===n.status)return console.error("[AI Alt Text] Authentication error - check nonce"),void o(!1,0,l||{message:"Authentication error. Please refresh the page and try again."});l&&l.message?o(!1,0,l):function(a,n,o){var i=a.length,r=0,l=0;!function n(d){var u=Math.min(d+5,i),c=a.slice(d,u).map(function(a){return e.ajax({url:t.rest||t.restRoot+"ai-alt/v1/generate/"+a,method:"POST",headers:{"X-WP-Nonce":t.nonce}}).done(function(){r++,s(++l,i)}).fail(function(){s(++l,i)})});e.when.apply(e,c).then(function(){u<i?setTimeout(function(){n(u)},500):o(r>0,r)}).fail(function(){console.error("[AI Alt Text] Fallback batch failed"),u<i?setTimeout(function(){n(u)},500):o(r>0,r)})}(0)}(a,0,function(e,t){o(e,t,null)})})}else o(!1,0)}function r(t,a,n){var o=e("[data-bulk-progress]");o.length&&(o.removeAttr("hidden"),e("[data-bulk-progress-label]").text(t||"Processing...")),s(n,a)}function s(t,a){var n=e("[data-bulk-progress]"),o=e("[data-bulk-progress-bar]"),i=e("[data-bulk-progress-counts]");if(n.length&&o.length){var r=a>0?Math.round(t/a*100):0;o.css("width",r+"%")}i.length&&i.text(t+" / "+a)}function l(){var t=e("[data-bulk-progress]");t.length&&t.attr("hidden","hidden")}function d(t,a){var n=e('<div class="notice notice-'+(a=a||"info")+' is-dismissible"><p>'+t+"</p></div>");e(".wrap").first().prepend(n),setTimeout(function(){n.fadeOut(function(){n.remove()})},5e3)}t.rest&&t.nonce?e(document).ready(function(){e(document).on("click",'[data-action="generate-missing"]',a),e(document).on("click",'[data-action="regenerate-all"]',n),e(document).on("click",'[data-action="regenerate-single"]',o)}):console.error("[AI Alt Text] JavaScript configuration missing. REST URL or nonce not found.")}(jQuery);