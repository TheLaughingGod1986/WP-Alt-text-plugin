!function(t){"use strict";t(document).on("click","button",function(){}),t(document).ready(function(){t(".ai-alt-dashboard__status").hide(),t("#ai-alt-bulk-progress").hide()});const e=window.wp&&window.wp.apiFetch?window.wp.apiFetch:null;function s(){return window.AI_ALT_GPT_DASH||window.AI_ALT_GPT||window.AI_ALT_GPT_CONFIG||{}}function a(t,e){if(!e)return"";const s=function(t){return t?t.restRoot||window.wpApiSettings&&window.wpApiSettings.root||"":window.wpApiSettings&&window.wpApiSettings.root||""}(t);let a=e;return s&&0===a.indexOf(s)&&(a=a.slice(s.length)),"/"===a.charAt(0)&&(a=a.slice(1)),a}function i(t,s,i={}){if(!s)return Promise.reject(new Error("Missing REST URL"));const o=i.method||"GET",n=i.data||null,r=!1!==i.parse,l=a(t,s);if(e&&l){const t={path:l,method:o};return n&&(t.data=n),r||(t.parse=!1),e(t)}const d=s,c={},u=t&&t.nonce?t.nonce:window.wpApiSettings&&window.wpApiSettings.nonce;return u&&(c["X-WP-Nonce"]=u),n&&(c["Content-Type"]="application/json"),fetch(d,{method:o,credentials:"include",headers:c,body:n?JSON.stringify(n):void 0}).then(t=>t.ok?r?t.json():t:t.json().catch(()=>({})).then(e=>{const s=new Error(e?.message||t.statusText||"Request failed");throw s.response=e,s.status=t.status,s}))}function o(t){return(new Intl.NumberFormat).format(t||0)}function n(t){return t?"string"==typeof t?t:t.message?t.message:t.response&&t.response.message?t.response.message:"Request failed":"Unknown error"}function r(t){return String(null==t?"":t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const l={calculateLevel:t=>Math.floor(t/50)+1,calculateXP(t){const e=t%50,s=e/50*100;return{current:e,total:50,percentage:Math.round(s)}},getLevelTitle:t=>t>=20?"Accessibility Legend":t>=15?"Alt Text Virtuoso":t>=10?"Description Master":t>=8?"Caption Champion":t>=5?"Alt Text Expert":t>=3?"Image Wizard":"Alt Text Apprentice",getLevelEmoji:t=>t>=20?"üëë":t>=15?"üèÜ":t>=10?"‚≠ê":t>=8?"üéñÔ∏è":t>=5?"üéØ":t>=3?"üöÄ":"üå±",achievements:[{id:"first_steps",title:"First Steps",description:"Generate your first alt text",emoji:"üë∂",requirement:1,check:t=>t.generated>=1},{id:"getting_started",title:"Getting Started",description:"Generate 10 alt texts",emoji:"üéØ",requirement:10,check:t=>t.generated>=10},{id:"on_a_roll",title:"On a Roll",description:"Generate 50 alt texts",emoji:"üî•",requirement:50,check:t=>t.generated>=50},{id:"century",title:"Century Club",description:"Generate 100 alt texts",emoji:"üíØ",requirement:100,check:t=>t.generated>=100},{id:"productivity_beast",title:"Productivity Beast",description:"Generate 250 alt texts",emoji:"ü¶Å",requirement:250,check:t=>t.generated>=250},{id:"legendary",title:"Legendary",description:"Generate 500+ alt texts",emoji:"üëë",requirement:500,check:t=>t.generated>=500},{id:"perfectionist",title:"Perfectionist",description:"Reach 100% coverage",emoji:"‚ú®",requirement:100,check:t=>t.coverage>=100},{id:"quality_assurance",title:"Quality Assurance",description:"All images rated Good or Excellent",emoji:"üèÖ",requirement:1,check:t=>100===t.coverage&&0===t.missing}],checkAchievements(t){return this.achievements.map(e=>({...e,unlocked:e.check(t),progress:Math.min(100,t.generated/e.requirement*100)}))}},d={confetti(){const e=t('<div class="ai-alt-confetti"></div>');t("body").append(e);const s=["#667eea","#f5576c","#4facfe","#43e97b","#ffd700","#fa709a"];for(let a=0;a<50;a++){const a=t('<div class="ai-alt-confetti-piece"></div>');a.css({left:100*Math.random()+"%",background:s[Math.floor(Math.random()*s.length)],animationDelay:.5*Math.random()+"s",animationDuration:2*Math.random()+2+"s"}),e.append(a)}setTimeout(()=>e.remove(),5e3)},sparkle(e,s){const a=t('<div class="ai-alt-sparkle">‚ú®</div>');a.css({left:e+"px",top:s+"px",fontSize:"2rem"}),t("body").append(a),setTimeout(()=>a.remove(),1e3)},levelUp(t){if(this.confetti(),c.show({type:"achievement",title:"üéâ Level Up!",message:`You've reached Level ${t}!`,duration:5e3}),window.Audio)try{const t=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTcIGGi67OifTRAMUKfj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgsvy2Yk3CBhpuuzpn00QDFA=");t.volume=.3,t.play().catch(()=>{})}catch(t){}},achievementUnlocked(e){c.show({type:"achievement",title:`${e.emoji} Achievement Unlocked!`,message:e.title,duration:5e3}),setTimeout(()=>{const s=t(`.ai-alt-achievement[data-achievement-id="${e.id}"]`);if(s.length){const t=s.offset();this.sparkle(t.left,t.top),this.sparkle(t.left+100,t.top)}},100)},fullCoverage(){this.confetti(),c.show({type:"success",title:"üéâ Perfect Score!",message:"All your images now have alt text! Amazing work!",duration:7e3})}},c={container:null,init(){this.container||(this.container=t('<div class="ai-alt-toast-container"></div>'),t("body").append(this.container))},show(e){this.init();const s=t.extend({},{type:"info",title:"",message:"",duration:4e3},e),a={success:"‚úÖ",error:"‚ùå",info:"‚ÑπÔ∏è",achievement:"üèÜ"},i=t(`\n                <div class="ai-alt-toast ${s.type}">\n                    <div class="ai-alt-toast-icon">${a[s.type]||a.info}</div>\n                    <div class="ai-alt-toast-content">\n                        ${s.title?`<div class="ai-alt-toast-title">${s.title}</div>`:""}\n                        <div class="ai-alt-toast-message">${s.message}</div>\n                    </div>\n                    <button class="ai-alt-toast-close" aria-label="Close">√ó</button>\n                </div>\n            `);this.container.append(i),i.find(".ai-alt-toast-close").on("click",function(){i.fadeOut(300,function(){t(this).remove()})}),s.duration>0&&setTimeout(()=>{i.fadeOut(300,function(){t(this).remove()})},s.duration)}};function s(){return window.AI_ALT_GPT_DASH||window.AI_ALT_GPT||window.AI_ALT_GPT_CONFIG||{}}const u={stats:null,previousStats:null,usage:null,queue:null,queueRefreshTimer:null,queueControlsBound:!1,billingControlsBound:!1,isQueueRefreshing:!1,bulkButtonBound:!1,isBulkProcessing:!1,isRefreshing:!1,config:null,bulkTotal:0,bulkProcessed:0,bulkSuccess:0,bulkFailures:0,init(){this.loadStats(),this.config=s(),this.usage=this.config&&this.config.initialUsage?this.config.initialUsage:null,this.renderUsage(),this.renderStatsToDom(),this.updateSavingsCopy(),this.togglePostOptimizeBanner(),this.initializeGamification(),this.initializeActionButtons(),this.initializeChart(),this.checkForNewAchievements(),this.initializeBulkButton(),this.cacheProgressEls(),this.updateBulkButtonState(),this.bindBillingControls(),this.bindQueueControls(),this.refreshStats(),this.refreshQueueStatus(),this.startQueuePolling()},loadStats(){const e=t(".ai-alt-dashboard--primary");if(e.length)try{this.stats=JSON.parse(e.attr("data-stats"));const t=localStorage.getItem("farlo_previous_stats");t&&(this.previousStats=JSON.parse(t))}catch(t){}},initializeGamification(){if(!this.stats)return;const e=parseInt(this.stats.generated)||0,s=l.calculateLevel(e),a=l.calculateXP(e),i=l.getLevelTitle(s),o=l.getLevelEmoji(s),n=t(`\n                <div class="ai-alt-gamification-header">\n                    <div class="ai-alt-level-badge">\n                        <span class="ai-alt-level-badge-icon">${o}</span>\n                        Level ${s} - ${i}\n                    </div>\n                    <div class="ai-alt-xp-container">\n                        <div class="ai-alt-xp-label">\n                            <span>Progress to Level ${s+1}</span>\n                            <span>${a.current}/${a.total} images</span>\n                        </div>\n                        <div class="ai-alt-xp-bar">\n                            <div class="ai-alt-xp-progress" style="width: ${a.percentage}%">\n                                ${a.percentage}%\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);if(t(".ai-alt-dashboard__intro").before(n),this.previousStats){const t=l.calculateLevel(parseInt(this.previousStats.generated)||0);s>t&&setTimeout(()=>{d.levelUp(s)},500)}this.renderAchievements()},renderAchievements(){if(!this.stats)return;const e=l.checkAchievements(this.stats),s=t('<div class="ai-alt-achievements-container"></div>');if(e.forEach(e=>{const a=t(`\n                    <div class="ai-alt-achievement ${e.unlocked?"unlocked":"locked"}" \n                         data-achievement-id="${e.id}"\n                         title="${e.description}">\n                        <div class="ai-alt-achievement-icon">${e.emoji}</div>\n                        <div class="ai-alt-achievement-title">${e.title}</div>\n                        <div class="ai-alt-achievement-description">${e.description}</div>\n                        ${e.unlocked?"":`<div class="ai-alt-achievement-progress">${Math.round(e.progress)}%</div>`}\n                    </div>\n                `);s.append(a)}),t(".ai-alt-gamification-header").after(s),this.previousStats){const t=l.checkAchievements(this.previousStats);e.forEach((e,s)=>{e.unlocked&&!t[s].unlocked&&setTimeout(()=>{d.achievementUnlocked(e)},1e3+500*s)})}},initializeActionButtons(){t(".ai-alt-action-card").each(function(e){t(this).addClass(["card-purple","card-green","card-blue"][e%3])}),t(".ai-alt-microcard").each(function(e){t(this).addClass(["gradient-purple","gradient-pink","gradient-blue","gradient-green"][e%4])});const e=["üìä","‚úÖ","‚ùå","üéØ"];t(".ai-alt-microcard").each(function(s){t(this).find(".ai-alt-microcard__icon").length||t(`<div class="ai-alt-microcard__icon">${e[s%4]}</div>`).prependTo(t(this))}),t(".ai-alt-action-card button, .ai-alt-action-card .button").each(function(e){t(this).addClass("ai-alt-btn "+["ai-alt-btn-primary","ai-alt-btn-success","ai-alt-btn-info"][e%3])})},initializeChart(){const e=t("#ai-alt-coverage");if(!e.length||!this.stats)return;if("undefined"==typeof Chart)return;const s=parseInt(this.stats.with_alt)||0,a=parseInt(this.stats.missing)||0,i=e[0].getContext("2d");new Chart(i,{type:"doughnut",data:{labels:["With ALT","Missing"],datasets:[{data:[s,a],backgroundColor:["rgba(67, 233, 123, 0.8)","rgba(245, 87, 108, 0.8)"],borderColor:["rgba(67, 233, 123, 1)","rgba(245, 87, 108, 1)"],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!0,cutout:"70%",plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(45, 55, 72, 0.95)",padding:12,cornerRadius:8,titleFont:{size:14,weight:"bold"},bodyFont:{size:13}}}}}),100===parseFloat(this.stats.coverage)&&0===a&&(!this.previousStats||parseFloat(this.previousStats.coverage)<100)&&setTimeout(()=>{d.fullCoverage()},1500)},checkForNewAchievements(){this.stats&&localStorage.setItem("farlo_previous_stats",JSON.stringify(this.stats))},updateStats(e,s={}){this.previousStats=this.stats,this.stats=e,localStorage.setItem("farlo_previous_stats",JSON.stringify(this.previousStats)),t(".ai-alt-gamification-header").remove(),t(".ai-alt-achievements-container").remove(),this.initializeGamification(),this.renderStatsToDom(),this.updateSavingsCopy(),this.togglePostOptimizeBanner(),this.updateBulkButtonState(),s.silent||c.show({type:"success",title:"‚ú® Great Work!",message:"Alt text generated successfully!",duration:3e3})},initializeBulkButton(){if(this.bulkButtonBound)return void this.updateBulkButtonState();t('[data-action="generate-missing"]');const e=this;t(document).off("click.aiAltBulk",'[data-action="generate-missing"]').on("click.aiAltBulk",'[data-action="generate-missing"]',function(s){s.preventDefault(),e.handleBulkButtonClick(t(this))}),this.bulkButtonBound=!0;const s=t("[data-bulk-progress]");this.usage&&this.usage.remaining<=0?(s.length&&s.prop("hidden",!0),this.hideProgressLog()):s.length&&!this.isBulkProcessing&&s.prop("hidden",!1),this.updateBulkButtonState()},handleBulkButtonClick(t){if(this.isBulkProcessing||!t.length||t.prop("disabled"))return;if(this.usage&&this.usage.remaining<=0)return void c.show({type:"warning",title:"Usage limit reached",message:"You've used all your free generations. Upgrade to Pro for unlimited AI generations.",duration:5e3});const e=s();if(!(e&&e.restMissing&&e.rest&&e.nonce))return void c.show({type:"error",title:"Configuration error",message:"Bulk generation endpoints unavailable.",duration:3500});this.config=e,this.isBulkProcessing=!0,t.prop("disabled",!0).addClass("loading").text("Processing Images..."),this.updateBulkButtonState(),"function"==typeof this.showProgressLog?this.showProgressLog():console.error("showProgressLog method not found on this object:",this),"function"==typeof this.addProgressLog?(this.addProgressLog("info","Starting bulk optimization..."),this.addProgressLog("info","Collecting images without ALT text...")):console.error("addProgressLog method not found on this object:",this);const a=this;i(e,e.restMissing).then(function(e){const s=Array.isArray(e?.ids)?e.ids:[];if(!s.length)return a.addProgressLog("info","No images found without ALT text"),a.addProgressLog("success","All images already have alt text!"),void setTimeout(()=>{a.hideProgressLog(),a.finishBulk(t),a.refreshStats()},2e3);a.progressStats.total=s.length,a.updateProgressStats(),a.addProgressLog("info",`Found ${s.length} images without ALT text`),a.addProgressLog("info","Starting AI generation process..."),a.startBulkGeneration(s).always(function(e){a.finishBulk(t),a.refreshStats()})}).catch(function(e){const s=n(e);c.show({type:"error",title:"Request failed",message:s,duration:3500}),a.finishBulk(t)})},finishBulk(t){if(this.isBulkProcessing=!1,t&&t.length&&t.prop("disabled",!1).removeClass("loading"),this.updateBulkButtonState(),"function"==typeof this.refreshUsageStats?this.refreshUsageStats({silentToast:!0}):"function"==typeof u.refreshUsageStats&&u.refreshUsageStats({silentToast:!0}),this.progressStats){const{success:t,errors:e}=this.progressStats;"function"==typeof this.addProgressLog&&this.addProgressLog("success",`Bulk optimization completed! ${t} successful, ${e} errors`),t>0&&c.show({type:"success",title:"Bulk complete",message:`‚úÖ ${t} alt texts generated successfully!`,duration:4400}),e>0&&c.show({type:"error",title:"Check results",message:`${e} images need attention. Review the progress log for details.`,duration:5200}),setTimeout(()=>{"function"==typeof this.hideProgressLog&&this.hideProgressLog()},3e3)}},updateBulkButtonState(){const e=t(".alttextai-bulk-btn");if(!e.length)return;const s=parseInt(this.stats?.missing||0,10),a=this.usage&&void 0!==this.usage.remaining?parseInt(this.usage.remaining,10):null;if(this.isBulkProcessing)return void e.prop("disabled",!0).addClass("loading").removeClass("ai-alt-btn-disabled").text("Processing Images...");if(null!==a&&a<=0){const t=s>0?`Upgrade to Unlock (${s} images waiting) ‚Üí`:"Upgrade to Unlock ‚Üí";return void e.prop("disabled",!1).removeClass("loading ai-alt-btn-disabled").addClass("alttextai-bulk-btn--limit").attr("data-action","show-upgrade-modal").text(t)}const i=s>0,o=i?`Optimize ${s} Remaining Images`:"All Images Optimized!";e.attr("data-action","generate-missing").removeClass("alttextai-bulk-btn--limit loading").prop("disabled",!i).toggleClass("ai-alt-btn-disabled",!i).text(o)},cacheProgressEls(){this.bulkProgress={container:t("[data-bulk-progress]"),label:t("[data-bulk-progress-label]"),counts:t("[data-bulk-progress-counts]"),bar:t("[data-bulk-progress-bar]")}},startProgress(t){this.bulkProgress||this.cacheProgressEls(),this.bulkTotal=Math.max(parseInt(t,10)||0,0),this.bulkProcessed=0,this.bulkSuccess=0,this.bulkFailures=0,this.bulkProgress&&this.bulkProgress.container.length&&this.bulkProgress.container.prop("hidden",!1),this.updateProgressUI("Starting bulk optimization‚Ä¶")},updateProgressUI(t){if(!this.bulkProgress)return;const e=this.bulkTotal||0,s=Math.max(e,1),a=Math.min(100,Math.round(this.bulkProcessed/s*100));if(this.bulkProgress.label&&this.bulkProgress.label.length&&this.bulkProgress.label.text(t),this.bulkProgress.counts&&this.bulkProgress.counts.length){const t=e>0?`${this.bulkProcessed}/${e}`:`${this.bulkProcessed}`;this.bulkProgress.counts.text(`${t} ¬∑ ${this.bulkSuccess} done ¬∑ ${this.bulkFailures} failed`)}this.bulkProgress.bar&&this.bulkProgress.bar.length&&this.bulkProgress.bar.css("width",`${a}%`)},noteSuccess(t){this.bulkProcessed+=1,this.bulkSuccess+=1,this.updateProgressUI(`Optimized image #${t}`)},noteFailure(t,e){this.bulkProcessed+=1,this.bulkFailures+=1,this.updateProgressUI(`Image #${t} failed: ${e}`)},stopProgress(){if(this.bulkProgress&&this.bulkProgress.container.length){const t=this.bulkProgress.container;setTimeout(()=>t.prop("hidden",!0),1500)}this.bulkTotal=this.bulkProcessed=this.bulkSuccess=this.bulkFailures=0},renderUsage(){if(!this.usage)return;const e=this.usage,s=t("[data-usage-text]");s.length&&s.text(`${e.used} of ${e.limit} free generations used`);const a=t("[data-usage-bar]"),i=parseInt(e.limit||e.max||0,10),o=i>0?i:1,n=Math.min(100,Math.max(0,Math.round(parseInt(e.used||0,10)/o*100)));this.usage.percentage=n,a.length&&a.css("width",`${n}%`).toggleClass("alttextai-progress-bar-fill--limit-reached",e.remaining<=0);const r=t(".alttextai-usage-alert");r.length&&(e.remaining<=0?r.text("üéØ You‚Äôve reached your free limit ‚Äî upgrade for more AI power!"):r.text(`${e.remaining} credits remain this cycle. Keep the momentum going!`));const l=t(".alttextai-reset-info");if(l.length)if(e.remaining<=0){const t=parseInt(e.days_until_reset||0,10),s=e.reset_date||"";let a="";t>0&&s?a=`Resets in ${t} days (${s})`:s&&(a=`Resets ${s}`),l.removeClass("hidden").text(a)}else l.addClass("hidden").text("");const d=t("[data-bulk-progress]");e.remaining<=0?(d.length&&d.prop("hidden",!0),this.hideProgressLog()):d.length&&!this.isBulkProcessing&&d.prop("hidden",!1),this.updateBulkButtonState()},bindBillingControls(){this.billingControlsBound||(t(document).on("click",'[data-action="open-billing-portal"]',function(t){t.preventDefault();const e=window.AltTextAI&&window.AltTextAI.billingPortalUrl||"",s=window.AltTextAI&&window.AltTextAI.upgradeUrl||"";return e?(u.trackUpgrade("billing-portal"),void window.open(e,"_blank","noopener")):s?(u.trackUpgrade("billing-fallback"),void window.open(s,"_blank","noopener")):void c.show({type:"info",title:"Billing",message:"Billing portal is not configured yet.",duration:3600})}),this.billingControlsBound=!0)},bindQueueControls(){if(this.queueControlsBound)return;const e=this;t(document).on("click",'[data-action="refresh-queue"]',function(s){s.preventDefault();const a=t(this);a.prop("disabled",!0).addClass("is-refreshing"),e.refreshQueueStatus({force:!0}).finally(()=>{a.prop("disabled",!1).removeClass("is-refreshing")})}),t(document).on("click",'[data-action="retry-failed"]',function(s){s.preventDefault();const a=t(this);e.performQueueAction({action:"alttextai_queue_retry_failed"},a,"Retrying failed jobs‚Ä¶","Failed jobs re-queued.","Unable to retry failed jobs.")}),t(document).on("click",'[data-action="retry-job"]',function(s){s.preventDefault();const a=t(this),i=parseInt(a.data("jobId"),10);i&&e.performQueueAction({action:"alttextai_queue_retry_job",job_id:i},a,"Retrying job‚Ä¶","Job re-queued.","Unable to retry this job.")}),t(document).on("click",'[data-action="clear-completed"]',function(s){s.preventDefault();const a=t(this);e.performQueueAction({action:"alttextai_queue_clear_completed"},a,"Clearing completed jobs‚Ä¶","Cleared completed jobs.","Unable to clear completed jobs.")}),this.queueControlsBound=!0},performQueueAction(e,s,a,i,o){const n=window.alttextai_ajax||{};if(s||(s=t()),!n.ajaxurl||!n.nonce)return c.show({type:"error",title:"Queue action failed",message:"AJAX configuration missing.",duration:4e3}),t.Deferred().reject().promise();const r=Object.assign({nonce:n.nonce},e||{});return r.action?(s.length&&s.prop("disabled",!0).addClass("is-refreshing"),a&&c.show({type:"info",title:"Queue",message:a,duration:2e3}),t.post(n.ajaxurl,r).done(t=>{if(t&&t.success)c.show({type:"success",title:"Queue",message:i||"Action completed.",duration:3200}),this.refreshQueueStatus({force:!0,silent:!0});else{const e=t?.data?.message||t?.data||o||"Action failed.";c.show({type:"error",title:"Queue",message:e,duration:4200})}}).fail(()=>{c.show({type:"error",title:"Queue",message:o||"Network error while performing queue action.",duration:4200})}).always(()=>{s.length&&s.prop("disabled",!1).removeClass("is-refreshing")})):(c.show({type:"error",title:"Queue action failed",message:"No action specified.",duration:4e3}),t.Deferred().reject().promise())},startQueuePolling(){this.stopQueuePolling();const t=this.config||s();t&&t.restQueue&&(this.queueRefreshTimer=setInterval(()=>this.refreshQueueStatus({silent:!0}),6e4))},stopQueuePolling(){this.queueRefreshTimer&&(clearInterval(this.queueRefreshTimer),this.queueRefreshTimer=null)},refreshQueueStatus(t={}){const e=this.config||s();if(!e||!e.restQueue)return Promise.resolve();if(this.isQueueRefreshing&&!t.force)return Promise.resolve();this.isQueueRefreshing=!0;return i(e,e.restQueue).then(t=>{this.queue=t||null,this.renderQueue()}).catch(e=>{t.silent||c.show({type:"error",title:"Queue status",message:n(e),duration:4200})}).finally(()=>{this.isQueueRefreshing=!1})},renderQueue(){const e=t(".alttextai-queue-card");if(!e.length)return;const s=this.queue||{},a=s.stats||{},i=t=>o(parseInt(t||0,10));t("[data-queue-pending]").text(i(a.pending)),t("[data-queue-processing]").text(i(a.processing)),t("[data-queue-failed]").text(i(a.failed));const n=void 0!==a.completed_recent?a.completed_recent:a.completed;t("[data-queue-completed]").text(i(n)),e.toggleClass("has-failures",(a.failed||0)>0);const r=t("[data-queue-failures-wrapper]"),l=t("[data-queue-failures]"),d=Array.isArray(s.failures)?s.failures:[];d.length?(l.html(d.map(t=>this.renderQueueItem(t,!0)).join("")),r.show()):(l.empty(),r.hide());const c=t("[data-queue-recent]"),u=Array.isArray(s.recent)?s.recent:[];u.length?c.html(u.map(t=>this.renderQueueItem(t,!1)).join("")):c.html('<p class="alttextai-queue-empty">Jobs will appear here when the queue runs.</p>')},renderQueueItem(t,e=!1){const s=parseInt(t.id||t.attachment_id||0,10),a=parseInt(t.attachment_id||0,10),i=t.attachment_title||`Attachment #${a||s}`,o=(t.status||"").toUpperCase(),n=parseInt(t.attempts||0,10),l=t.source?t.source.toUpperCase():"",d=this.formatQueueDate(t.enqueued_at),c=this.formatQueueDate(t.locked_at),u=this.formatQueueDate(t.completed_at),g=t.edit_url?r(t.edit_url):"",h=[];o&&h.push(`Status: ${o}`),l&&h.push(`Source: ${l}`),n&&h.push(`Attempts: ${n}`),d&&h.push(`Queued: ${d}`),c&&h.push(`Locked: ${c}`),u&&h.push(`Completed: ${u}`),h.length||!s&&!a||h.push(`Job #${s||a}`);const p=h.length?h.map(t=>r(t)).join(" ‚Ä¢ "):"",f=t.last_error?`<p class="alttextai-queue-item__error">${r(t.last_error)}</p>`:"",m=g?`<a class="alttextai-queue-item__link" href="${g}" target="_blank" rel="noopener noreferrer">View attachment</a>`:"",b=e&&s?`<button type="button" class="alttextai-queue-btn alttextai-queue-btn--ghost" data-action="retry-job" data-job-id="${s}">Retry job</button>`:"";return`\n                <div class="alttextai-queue-item ${e?"alttextai-queue-item--failed":""}">\n                    <p class="alttextai-queue-item__title">${r(i)}</p>\n                    <div class="alttextai-queue-item__meta">${p}</div>\n                    ${m}\n                    ${b}\n                    ${f}\n                </div>\n            `},trackUpgrade(e="dashboard"){const s=window.alttextai_ajax||{};s.ajaxurl&&s.nonce&&t.post(s.ajaxurl,{action:"alttextai_track_upgrade",nonce:s.nonce,source:e})},formatQueueDate(t){if(!t)return"";const e=String(t).replace(" ","T"),s=new Date(e);return Number.isNaN(s.getTime())?t:s.toLocaleString()},renderStatsToDom(){if(!this.stats)return;const e=t=>o(parseInt(t||0,10));t("[data-stat-with-alt]").text(e(this.stats.with_alt)),t("[data-stat-missing]").text(e(this.stats.missing))},updateSavingsCopy(){if(!this.stats)return;const e=t("[data-savings-copy]");if(!e.length)return;const s=2*parseInt(this.stats.with_alt||0,10)/60,a=s>=10?0:1,i=s.toFixed(a);e.text(`You‚Äôve saved ${i} hours of manual work! (est. 2 min/image)`)},togglePostOptimizeBanner(){const e=t("[data-post-optimize-banner]");if(!e.length||!this.stats)return;const s=parseInt(this.stats.missing||0,10),a=parseInt(this.stats.with_alt||0,10);0===s&&a>0?e.removeClass("hidden").attr("aria-hidden","false"):e.addClass("hidden").attr("aria-hidden","true")},refreshStats(){const t=this.config||s();if(!t||!t.restStats)return void this.updateBulkButtonState();if(this.isRefreshing)return;this.isRefreshing=!0;const e=i(t,function(t,e,s){if(!t)return"";const a=-1===t.indexOf("?")?"?":"&";return`${t}${a}${encodeURIComponent(e)}=${encodeURIComponent(s)}`}(t.restStats,"fresh","1")),a=t.restUsage?i(t,t.restUsage):Promise.resolve(null);Promise.all([e,a]).then(([t,e])=>{t&&!t.code&&this.updateStats(t,{silent:!0}),e&&!e.code&&(this.usage=e,this.renderUsage())}).catch(()=>{}).finally(()=>{this.isRefreshing=!1,this.updateBulkButtonState()})},startBulkGeneration(e){const a=Array.isArray(e)?e.slice():[];if(!a.length)return t.Deferred().resolve().promise();const o=this,r=t.Deferred();a.length;let l=0,d=0,c=0,u=null;const g=this.config||s(),h=g&&g.rest?g.rest.replace(/\/$/,""):"",p=function(){if(!a.length){o.progressStats.processed=l,o.progressStats.success=d,o.progressStats.errors=c,o.updateProgressStats();const t=`Bulk run completed: ${d} success ¬∑ ${c} failed.`;return o.addProgressLog("success",t),void r.resolve({successes:d,failures:c})}const t=a.shift(),e=`${h}/${t}`,s=o.getImageName?o.getImageName(t):`Image ID ${t}`;o.addProgressLog("info",`Processing ${s}...`),u=setTimeout(()=>{o.addProgressLog("error",`‚è∞ Timeout processing ${s} - skipping`),c+=1,l+=1,o.progressStats.errors=c,o.progressStats.processed=l,o.updateProgressStats(),setTimeout(p,100)},3e4),i(g,e,{method:"POST"}).then(e=>{clearTimeout(u),d+=1,l+=1,o.progressStats.success=d,o.progressStats.processed=l,o.updateProgressStats(),o.addProgressLog("success",`‚úÖ Successfully generated alt text for ${s}`),o.noteSuccess(t)}).catch(e=>{clearTimeout(u),c+=1,l+=1,o.progressStats.errors=c,o.progressStats.processed=l,o.updateProgressStats();const i=n(e);o.addProgressLog("error",`‚ùå Failed to process ${s}: ${i}`),o.noteFailure(t,i);e&&e.response&&("limit_reached"===e.response.code||"LIMIT_REACHED"===e.response.code)&&(o.addProgressLog("warning","‚ö†Ô∏è Monthly limit reached. Stopping bulk optimization."),a.length=0)}).finally(()=>{clearTimeout(u),l+=1,o.progressStats.processed=l,o.updateProgressStats(),setTimeout(p,500)})};return p(),r.promise()},showProgressLog(){if(this.usage&&parseInt(this.usage.remaining||0,10)<=0)return void this.hideProgressLog();const e=t("#ai-alt-bulk-progress"),s=t('<div class="alttextai-progress-overlay"></div>');e.length&&(t("body").append(s),e.show(),t(".ai-alt-dashboard__status").show(),this.progressStats={total:0,processed:0,success:0,errors:0},this.updateProgressStats())},hideProgressLog(){const e=t("#ai-alt-bulk-progress"),s=t(".alttextai-progress-overlay");e.length&&(e.hide(),s.remove()),t(".ai-alt-dashboard__status").hide()},addProgressLog(e,s){const a=t(".alttextai-progress-log-content");if(!a.length)return;const i=(new Date).toLocaleTimeString(),o=t(`\n                <div class="alttextai-progress-log-entry ${`alttextai-progress-log-entry--${e}`}">\n                    <span class="alttextai-progress-log-time">${i}</span>\n                    <span class="alttextai-progress-log-message">${s}</span>\n                </div>\n            `);a.append(o),a.scrollTop(a[0].scrollHeight)},updateProgressStats(){if(!this.progressStats)return;const{total:e,processed:s,success:a,errors:i}=this.progressStats,o=e>0?Math.round(s/e*100):0;t(".alttextai-progress-stat__percentage").text(`${o}%`),t(".alttextai-progress-stat__count").text(s),t(".alttextai-progress-stat__success").text(a),t(".alttextai-progress-stat__errors").text(i),t(".alttextai-progress-bar-fill").css("width",`${o}%`)}},g={addSparkleOnClick(){t(document).on("click",".ai-alt-btn, .ai-alt-achievement.unlocked, .ai-alt-microcard",function(t){d.sparkle(t.pageX,t.pageY)})},addSoundEffects(){},addKeyboardShortcuts(){t(document).on("keydown",function(e){(e.ctrlKey||e.metaKey)&&"g"===e.key&&(e.preventDefault(),t('[data-action="generate-missing"]').first().click())})},enhanceTooltips(){t("[title]").each(function(){t(this).attr("data-tooltip",t(this).attr("title")),t(this).removeAttr("title")})},bindUpgradeModal(){const e=u,s=u;t(document).off("click.alttextaiRegenerate").on("click.alttextaiRegenerate",'.alttextai-btn-regenerate, [data-action="regenerate-single"]',function(a){a.preventDefault();const i=t(this),o=i.data("attachment-id");if(!o)return void c.show({type:"error",title:"Missing ID",message:"We could not find that attachment. Please refresh and try again.",duration:3200});const n=i.html();i.prop("disabled",!0).addClass("loading").text("Regenerating‚Ä¶"),t.ajax({url:ajaxurl,type:"POST",data:{action:"alttextai_regenerate_single",attachment_id:o,nonce:alttextai_ajax.nonce}}).done(function(t){if(!t||!t.success){if("limit_reached"===t?.data?.code)return s.trackUpgrade("limit-reached"),void e.showUpgradeModal();const a=t?.data?.message||"Failed to regenerate alt text";return void c.show({type:"error",title:"Regeneration failed",message:a,duration:3800})}const a=r(t.data.alt_text||""),o=i.closest("tr"),n=`\n                        <button type="button" class="alttextai-copy-trigger" data-copy-alt="${a}" aria-label="Copy alt text to clipboard">\n                            <span class="alttextai-copy-text">${a}</span>\n                            <span class="alttextai-copy-icon" aria-hidden="true">üìã</span>\n                        </button>\n                    `;o.find(".alttextai-table__cell--new").html(n),o.attr("data-status","regenerated");o.find(".alttextai-status-badge").removeClass("alttextai-status-badge--optimized alttextai-status-badge--missing").addClass("alttextai-status-badge--regenerated").text("üîÅ Regenerated"),c.show({type:"success",title:"‚ö° Regenerated",message:"Regenerated alt text based on new context.",duration:3200}),u.refreshUsageStats({silentToast:!0}),u.refreshStats()}).fail(function(){c.show({type:"error",title:"Network error",message:"Something went wrong. Please try again.",duration:3800})}).always(function(){i.prop("disabled",!1).removeClass("loading").html(n)})}),t(document).on("click",'[data-action="show-upgrade-modal"]',function(a){a.preventDefault();const i=t(this).data("upgradeSource")||"dashboard";s.trackUpgrade(i),e.showUpgradeModal()}),t(document).on("click","#alttextai-show-auth-banner-btn",function(t){t.preventDefault(),window.AltTextAuthModal&&"function"==typeof window.AltTextAuthModal.show?window.AltTextAuthModal.show():c.show({type:"info",title:"Authentication",message:"Please wait while the authentication modal loads...",duration:3e3})}),t(document).on("click",'[data-action="close-modal"]',function(t){t.preventDefault(),e.hideUpgradeModal()}),t(document).on("click",".alttextai-modal-backdrop",function(t){t.target===this&&e.hideUpgradeModal()}),t(document).on("keydown.alttextaiModal",function(t){"Escape"===t.key&&e.hideUpgradeModal()}),t(document).on("click",'[data-action="refresh-usage"]',function(t){t.preventDefault(),u.refreshUsageStats({showToast:!0})}),t(document).on("click",".alttextai-copy-trigger",function(e){e.preventDefault();const s=t(this).data("copy-alt")||"";if(!s)return;(navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(s):new Promise((t,e)=>{const a=document.createElement("textarea");a.value=s,a.style.position="fixed",a.style.opacity="0",document.body.appendChild(a),a.focus(),a.select();try{const s=document.execCommand("copy");document.body.removeChild(a),s?t():e()}catch(t){document.body.removeChild(a),e(t)}})).then(()=>{c.show({type:"success",title:"Copied",message:"Alt text copied to your clipboard.",duration:2200})}).catch(()=>{c.show({type:"error",title:"Copy failed",message:"Please press ‚åò+C / Ctrl+C to copy manually.",duration:3200})})}),t(document).on("click",".alttextai-progress-close",function(t){t.preventDefault(),e.hideProgressLog()}),t(document).on("click",".alttextai-progress-overlay",function(t){t.target===this&&e.hideProgressLog()}),t(document).on("click",".alttextai-progress-cancel",function(e){e.preventDefault(),s.isBulkProcessing&&(s.addProgressLog("warning","üõë Cancelling bulk optimization..."),s.isBulkProcessing=!1,s.finishBulk(t('[data-action="generate-missing"]')))}),t(document).on("click",'[data-action="open-billing-portal"]',function(e){e.preventDefault();const s=t(this);if(!(window.alttextai_ajax?.is_authenticated||!1))return void c.show({type:"info",title:"Account Required",message:"Please sign in to manage your billing.",duration:4e3});const a=s.text();s.text("Opening...").css("opacity","0.6"),t.ajax({url:window.alttextai_ajax?.ajaxurl||"/wp-admin/admin-ajax.php",method:"POST",data:{action:"alttextai_create_portal",nonce:window.alttextai_ajax?.nonce||""},success:function(t){t.success&&t.data.url?window.location.href=t.data.url:(c.show({type:"error",title:"Portal Error",message:t.data?.message||"Failed to open billing portal",duration:5e3}),s.text(a).css("opacity","1"))},error:function(){c.show({type:"error",title:"Connection Error",message:"Unable to open billing portal. Please try again.",duration:5e3}),s.text(a).css("opacity","1")}})}),t(document).on("click",'[data-action="upgrade-plan"], [data-action="upgrade-agency"], [data-action="buy-credits"]',function(e){e.preventDefault();const s=t(this),a=s.data("action");let i=s.data("price-id")||s.data("priceId");if(i||("upgrade-plan"===a?i="price_1SKgtuJl9Rm418cMtcxOZRCR":"upgrade-agency"===a?i="price_1SKgu9Jl9Rm418cMVhg3ZBZS":"buy-credits"===a&&(i="price_1SKgu2Jl9Rm418cM3b1Z9tUW")),!i)return void console.error("No price ID specified");window.alttextai_ajax?.is_authenticated||!1?(s.prop("disabled",!0).addClass("loading"),t.ajax({url:window.alttextai_ajax?.ajaxurl||"/wp-admin/admin-ajax.php",method:"POST",data:{action:"alttextai_create_checkout",nonce:window.alttextai_ajax?.nonce||"",price_id:i},success:function(t){t.success&&t.data.url?window.location.href=t.data.url:(c.show({type:"error",title:"Checkout Error",message:t.data?.message||"Failed to create checkout session",duration:5e3}),s.prop("disabled",!1).removeClass("loading"))},error:function(){c.show({type:"error",title:"Connection Error",message:"Unable to start checkout. Please try again.",duration:5e3}),s.prop("disabled",!1).removeClass("loading")}})):window.AltTextAuthModal&&"function"==typeof window.AltTextAuthModal.show?window.AltTextAuthModal.show():c.show({type:"info",title:"Account Required",message:"Please create an account or sign in to upgrade.",duration:4e3})})},showUpgradeModal(){const e=t("#alttextai-upgrade-modal");e.length&&(e.fadeIn(300),document.body.style.overflow="hidden")},hideUpgradeModal(){const e=t("#alttextai-upgrade-modal");e.length&&(e.fadeOut(300),document.body.style.overflow="")},showToast(e,s="info",a=null){t(".alttextai-toast").remove();a||(a="success"===s?"Success!":"error"===s?"Error":"Info");const i=t(`\n                <div class="alttextai-toast ${"success"===s?"alttextai-toast--success":"error"===s?"alttextai-toast--error":"alttextai-toast--info"}">\n                    <div class="alttextai-toast__icon">${"success"===s?"‚úì":"error"===s?"‚ö†":"‚Ñπ"}</div>\n                    <div class="alttextai-toast__content">\n                        <div class="alttextai-toast__title">${a}</div>\n                        <div class="alttextai-toast__message">${e}</div>\n                    </div>\n                    <button class="alttextai-toast__close" aria-label="Close notification">\n                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">\n                            <path d="M8 8.707l3.646 3.647.708-.707L8.707 8l3.647-3.646-.707-.708L8 7.293 4.354 3.646l-.707.708L7.293 8l-3.646 3.646.707.708L8 8.707z"/>\n                        </svg>\n                    </button>\n                </div>\n            `);t("body").append(i),setTimeout(()=>i.addClass("alttextai-toast--show"),100);setTimeout(()=>{i.removeClass("alttextai-toast--show").addClass("alttextai-toast--hide"),setTimeout(()=>i.remove(),300)},"error"===s?7e3:5e3),i.find(".alttextai-toast__close").on("click",function(){i.removeClass("alttextai-toast--show").addClass("alttextai-toast--hide"),setTimeout(()=>i.remove(),300)})},refreshUsageStats(e={}){const s=t.extend({showToast:!1,silentToast:!1},e),a=t('[data-action="refresh-usage"]');a.each(function(){const e=t(this);e.data("alttextai-original")||e.data("alttextai-original",e.html()),e.prop("disabled",!0).addClass("is-refreshing").html('<span aria-hidden="true">üîÑ</span> Refreshing‚Ä¶')});const i=this;return t.ajax({url:ajaxurl,type:"POST",data:{action:"alttextai_refresh_usage",nonce:alttextai_ajax.nonce}}).done(function(t){if(t&&t.success)return i.usage=t.data,i.renderUsage(),void(s.showToast&&!s.silentToast&&c.show({type:"success",title:"Usage updated",message:"Usage data refreshed successfully.",duration:2600}));const e=t?.data?.message||"Could not refresh usage data.";c.show({type:"error",title:"Refresh failed",message:e,duration:4200})}).fail(function(){c.show({type:"error",title:"Network error",message:"We couldn‚Äôt refresh usage right now. Please try again.",duration:4200})}).always(function(){a.each(function(){const e=t(this),s=e.data("alttextai-original");void 0!==s&&e.html(s),e.prop("disabled",!1).removeClass("is-refreshing")}),i.updateBulkButtonState()})},addProgressLog(e,s){const a=t(".alttextai-progress-log-content");if(!a.length)return;const i=(new Date).toLocaleTimeString(),o=t(`\n                <div class="alttextai-progress-log-entry ${`alttextai-progress-log-entry--${e}`}">\n                    <span class="alttextai-progress-log-time">${i}</span>\n                    <span class="alttextai-progress-log-message">${s}</span>\n                </div>\n            `);a.append(o),a.scrollTop(a[0].scrollHeight)},updateProgressStats(){if(!this.progressStats)return;const{total:e,processed:s,success:a,errors:i}=this.progressStats,o=e>0?Math.round(s/e*100):0,n=t(".alttextai-progress-percentage"),r=t(".alttextai-progress-count"),l=t(".alttextai-progress-success"),d=t(".alttextai-progress-errors"),c=t(".alttextai-progress-bar-fill");n.length&&n.text(`${o}%`),r.length&&r.text(`${s} / ${e}`),l.length&&l.text(a),d.length&&d.text(i),c.length&&c.css("width",`${o}%`)},getImageName(e){const s=t(`[data-attachment-id="${e}"]`).closest("tr");if(s.length){const t=s.find("img");if(t.length){const s=t.attr("src");if(s){return s.split("/").pop()||`Image ID ${e}`}}}return`Image ID ${e}`},initCountdown(){const e=t(".alttextai-countdown");if(!e.length)return;const s=parseInt(e.data("countdown")||0,10);if(s<=0)return e.find("[data-days]").text("0"),e.find("[data-hours]").text("0"),void e.find("[data-minutes]").text("0");let a=s;function i(){if(a<=0)return e.find("[data-days]").text("0"),e.find("[data-hours]").text("0"),void e.find("[data-minutes]").text("0");const t=Math.floor(a/86400),s=Math.floor(a%86400/3600),i=Math.floor(a%3600/60);e.find("[data-days]").text(t),e.find("[data-hours]").text(s),e.find("[data-minutes]").text(i),a-=60}i(),setInterval(i,6e4)},checkUsageStateOnLoad(){const e=t(".alttextai-usage-text");if(!e.length)return;const s=e.text().match(/(\d+) of (\d+)/);if(!s)return;if(parseInt(s[1],10)>=parseInt(s[2],10)){const e=t(".alttextai-bulk-btn");e.addClass("alttextai-bulk-btn--limit"),e.append('<span class="alttextai-bulk-btn__badge">LIMIT REACHED</span>'),e.prop("disabled",!0),t(".ai-alt-dashboard__status").hide(),t("#ai-alt-bulk-progress").hide(),t(".alttextai-progress-overlay").remove()}}};t(document).ready(function(){if(t(".alttextai-clean-dashboard").length&&(u.init(),g.addSparkleOnClick(),g.addKeyboardShortcuts(),g.bindUpgradeModal(),g.initCountdown(),setTimeout(()=>{"function"==typeof u.checkUsageStateOnLoad&&u.checkUsageStateOnLoad()},100),setTimeout(()=>{c.show({type:"info",title:"üëã Welcome back!",message:"Keep up the great work on your accessibility journey!",duration:4e3})},500)),void 0!==window.AI_ALT_GPT){const t=window.AI_ALT_GPT.onGenerationSuccess;window.AI_ALT_GPT.onGenerationSuccess=function(e){t&&t.call(this,e),c.show({type:"success",title:"‚ú® Alt Text Generated",message:`Successfully processed image #${e.id||"unknown"}`,duration:2e3})}}}),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&(window.addEventListener("ai-alt-stats-update",function(t){if(!t||!t.detail)return;const e=t.detail.stats||t.detail,s=t.detail.usage||null;e&&"object"==typeof e&&u.updateStats(e,{silent:!0}),s&&"object"==typeof s&&(u.usage=s,u.renderUsage())}),window.addEventListener("beforeunload",function(){window.AiAltDashboard&&"function"==typeof window.AiAltDashboard.stopQueuePolling&&window.AiAltDashboard.stopQueuePolling()})),window.AiAltGamification=l,window.AiAltCelebration=d,window.AiAltToast=c,window.AiAltDashboard=u,window.AiAltEnhancements=g,window.showUpgradeModal=function(){g.showUpgradeModal()},window.hideUpgradeModal=function(){g.hideUpgradeModal()}}(jQuery);