<<<<<<< HEAD
class AltTextAuthModal{constructor(){this.apiUrl=this.getApiUrl(),this.token=this.getStoredToken(),this.modalElement=null,this.formElements={},this.init()}getApiUrl(){if(window.alttextai_ajax?.api_url)return window.alttextai_ajax.api_url;const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"http://localhost:3001":(console.error("[AltText AI] API URL not configured"),null)}init(){this.createModalHTML(),this.modalElement=document.getElementById("alttext-auth-modal"),this.formElements={login:document.getElementById("alttext-login-form"),register:document.getElementById("alttext-register-form"),forgotPassword:document.getElementById("alttext-forgot-password-form"),resetPassword:document.getElementById("alttext-reset-password-form")},this.bindEvents(),this.checkAuthStatus(),this.checkResetPasswordParams()}checkResetPasswordParams(){const e=new URLSearchParams(window.location.search),t=e.get("reset-token"),s=e.get("email");t&&s&&(this.show(),this.showResetPasswordForm(s,t))}checkPasswordStrength(e,t){const s=e.replace("-password","-password-strength"),a=e.replace("-password","-password-strength-fill"),o=e.replace("-password","-password-strength-label"),r=e.replace("-password","-password-hint"),n=document.getElementById(s),i=document.getElementById(a),l=document.getElementById(o),d=document.getElementById(r);if(!n||!i||!l)return;if(!t||0===t.length)return n.style.display="none",void(d&&(d.style.display="block"));n.style.display="block",d&&(d.style.display="none");let c=0,m="",u="";t.length>=8&&c++,t.length>=12&&c++,/[a-z]/.test(t)&&/[A-Z]/.test(t)&&c++,/\d/.test(t)&&c++,/[^a-zA-Z\d]/.test(t)&&c++,c<=1?(m="Weak",u="#ef4444",i.style.width="25%"):2===c?(m="Fair",u="#f59e0b",i.style.width="50%"):3===c?(m="Good",u="#3b82f6",i.style.width="75%"):(m="Strong",u="#10b981",i.style.width="100%"),i.style.backgroundColor=u,l.textContent=m,l.style.color=u}createModalHTML(){document.body.insertAdjacentHTML("beforeend",'\n            <div id="alttext-auth-modal" class="alttext-auth-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="alttext-auth-modal-title" aria-describedby="alttext-auth-modal-desc">\n                <div class="alttext-auth-modal__overlay">\n                    <div class="alttext-auth-modal__content">\n                        <div class="alttext-auth-modal__header">\n                            <h2 class="alttext-auth-modal__title" id="alttext-auth-modal-title">SEO AI Alt Text Account</h2>\n                            <button class="alttext-auth-modal__close" type="button" aria-label="Close dialog">&times;</button>\n                        </div>\n                        \n                        <div class="alttext-auth-modal__body">\n                            \x3c!-- Login Form --\x3e\n                            <div id="alttext-login-form" class="alttext-auth-form">\n                                <h3>Sign In</h3>\n                                <form id="login-form" autocomplete="on" aria-label="Sign in to your SEO AI Alt Text account">\n                                    <div class="alttext-form-group">\n                                        <label for="login-email">Email</label>\n                                        <input type="email" id="login-email" name="email" autocomplete="username" required aria-required="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="login-password">Password</label>\n                                        <input type="password" id="login-password" name="password" autocomplete="current-password" required aria-required="true">\n                                        <a href="#" id="show-forgot-password" class="alttext-forgot-password-link" aria-label="Reset your password">Forgot password?</a>\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Sign in">\n                                        <span class="alttext-btn__text">Sign In</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Don\'t have an account?\n                                    <a href="#" id="show-register" aria-label="Switch to registration form">Create one here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Register Form --\x3e\n                            <div id="alttext-register-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Create Account</h3>\n                                <form id="register-form" autocomplete="off" aria-label="Create a new SEO AI Alt Text account">\n                                    <div class="alttext-form-group">\n                                        <label for="register-email">Email</label>\n                                        <input type="email" id="register-email" name="email" autocomplete="off" required aria-required="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="register-password">Password</label>\n                                        <input type="password" id="register-password" name="password" autocomplete="new-password" minlength="8" required aria-required="true" aria-describedby="register-password-strength-label register-password-hint">\n                                        <div class="alttext-password-strength" id="register-password-strength" style="display: none;" role="status" aria-live="polite" aria-atomic="true">\n                                            <div class="alttext-password-strength-bar" aria-hidden="true">\n                                                <div class="alttext-password-strength-fill" id="register-password-strength-fill" aria-hidden="true"></div>\n                                            </div>\n                                            <span class="alttext-password-strength-label" id="register-password-strength-label"></span>\n                                        </div>\n                                        <small id="register-password-hint">Minimum 8 characters</small>\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="register-confirm">Confirm Password</label>\n                                        <input type="password" id="register-confirm" name="confirmPassword" autocomplete="new-password" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Create account">\n                                        <span class="alttext-btn__text">Create Account</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Already have an account?\n                                    <a href="#" id="show-login" aria-label="Switch to sign in form">Sign in here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Forgot Password Form --\x3e\n                            <div id="alttext-forgot-password-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Reset Password</h3>\n                                <p class="alttext-forgot-password-info" id="alttext-auth-modal-desc">Enter your email address and we\'ll send you a link to reset your password.</p>\n                                <form id="forgot-password-form" autocomplete="on" aria-label="Request password reset">\n                                    <div class="alttext-form-group">\n                                        <label for="forgot-email">Email</label>\n                                        <input type="email" id="forgot-email" name="email" autocomplete="username" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Send password reset link">\n                                        <span class="alttext-btn__text">Send Reset Link</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Remember your password?\n                                    <a href="#" id="show-login-from-forgot" aria-label="Switch to sign in form">Sign in here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Reset Password Form --\x3e\n                            <div id="alttext-reset-password-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Set New Password</h3>\n                                <p class="alttext-reset-password-info">Enter your new password below.</p>\n                                <form id="reset-password-form" autocomplete="off" aria-label="Reset your password">\n                                    <div class="alttext-form-group">\n                                        <label for="reset-email">Email</label>\n                                        <input type="email" id="reset-email" name="email" autocomplete="username" required readonly aria-readonly="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-token">Reset Token</label>\n                                        <input type="text" id="reset-token" name="token" required readonly aria-readonly="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-password">New Password</label>\n                                        <input type="password" id="reset-password" name="password" autocomplete="new-password" minlength="8" required aria-required="true" aria-describedby="reset-password-strength-label reset-password-hint">\n                                        <div class="alttext-password-strength" id="reset-password-strength" style="display: none;" role="status" aria-live="polite" aria-atomic="true">\n                                            <div class="alttext-password-strength-bar" aria-hidden="true">\n                                                <div class="alttext-password-strength-fill" id="reset-password-strength-fill" aria-hidden="true"></div>\n                                            </div>\n                                            <span class="alttext-password-strength-label" id="reset-password-strength-label"></span>\n                                        </div>\n                                        <small id="reset-password-hint">Minimum 8 characters</small>\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-confirm">Confirm New Password</label>\n                                        <input type="password" id="reset-confirm" name="confirmPassword" autocomplete="new-password" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Reset password">\n                                        <span class="alttext-btn__text">Reset Password</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    <a href="#" id="show-login-from-reset" aria-label="Switch to sign in form">Back to sign in</a>\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ')}bindEvents(){const e=this;document.addEventListener("click",function(t){return t.target.closest(".alttext-auth-modal__close")?(t.preventDefault(),t.stopPropagation(),void e.hide()):t.target.classList.contains("alttext-auth-modal__overlay")?void e.hide():"show-register"===t.target.id||t.target.closest("#show-register")?(t.preventDefault(),t.stopPropagation(),void e.showRegisterForm()):"show-login"===t.target.id||t.target.closest("#show-login")?(t.preventDefault(),t.stopPropagation(),void e.showLoginForm()):"show-forgot-password"===t.target.id||t.target.closest("#show-forgot-password")?(t.preventDefault(),t.stopPropagation(),void e.showForgotPasswordForm()):"show-login-from-forgot"===t.target.id||t.target.closest("#show-login-from-forgot")||"show-login-from-reset"===t.target.id||t.target.closest("#show-login-from-reset")?(t.preventDefault(),t.stopPropagation(),void e.showLoginForm()):void 0},!0),document.addEventListener("submit",function(t){return"login-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleLogin()):"register-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleRegister()):"forgot-password-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleForgotPassword()):"reset-password-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleResetPassword()):void 0},!0),document.addEventListener("keydown",function(t){if("Escape"===t.key&&e.modalElement&&"block"===e.modalElement.style.display&&e.hide(),e.modalElement&&"block"===e.modalElement.style.display){const s=e.modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=s[0],o=s[s.length-1];"Tab"===t.key&&(t.shiftKey&&document.activeElement===a?(t.preventDefault(),o.focus()):t.shiftKey||document.activeElement!==o||(t.preventDefault(),a.focus()))}}),document.addEventListener("input",function(t){"reset-password"!==t.target.id&&"register-password"!==t.target.id||e.checkPasswordStrength(t.target.id,t.target.value)})}show(){if(this.modalElement||this.init(),this.modalElement){this.modalElement.style.display="block",document.body.style.overflow="hidden";const e=this.modalElement.querySelector('input[type="email"], input[type="password"], button');e&&e.focus()}else console.error("[AltText AI] Modal element not found. Cannot show modal.")}hide(){this.modalElement&&(this.modalElement.style.display="none",document.body.style.overflow="")}showLoginForm(){this.formElements.login&&(this.formElements.login.style.display="block"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showRegisterForm(){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="block"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showForgotPasswordForm(){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="block"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showResetPasswordForm(e,t){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="block");const s=document.getElementById("reset-email"),a=document.getElementById("reset-token");s&&e&&(s.value=e),a&&t&&(a.value=t)}async handleLogin(){const e=document.getElementById("login-form"),t=new FormData(e),s=t.get("email"),a=t.get("password");if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const e=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_login",email:s,password:a,nonce:window.alttextai_ajax.nonce})}),t=await e.json();if(t.success)t.data,this.hide(),this.showSuccess("Welcome back! You are now signed in to SEO AI Alt Text."),setTimeout(()=>{window.location.reload()},1500);else{const e=t.data?.message||t.message||"Login failed";this.showError(e)}}catch(e){console.error("Login error:",e),"TypeError"===e.name&&e.message.includes("fetch")?this.showError("Unable to connect to authentication server. The service may be temporarily unavailable. Please try again in a few minutes."):this.showError("Network error. Please try again.")}finally{this.setLoading(e,!1)}}async handleRegister(){const e=document.getElementById("register-form"),t=new FormData(e),s=t.get("email"),a=t.get("password");if(a===t.get("confirmPassword")){if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const e=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_register",email:s,password:a,nonce:window.alttextai_ajax.nonce})}),t=await e.json();if(t.success)t.data,this.hide(),this.showSuccess("Account created successfully! Welcome to SEO AI Alt Text."),setTimeout(()=>{window.location.reload()},1500);else{const e=t.data?.message||t.message||"Registration failed";this.showError(e)}}catch(e){console.error("Registration error:",e),this.showError("Network error. Please try again.")}finally{this.setLoading(e,!1)}}else this.showError("Passwords do not match")}async handleForgotPassword(){const e=document.getElementById("forgot-password-form"),t=new FormData(e).get("email");if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const s=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_forgot_password",email:t,nonce:window.alttextai_ajax.nonce})});if(!s.ok){let t;try{t=await s.json()}catch(e){t={message:`Server error (${s.status})`}}this.setLoading(e,!1);const a=t.data?.message||t.message||`Request failed with status ${s.status}`;return void this.showError(a)}const a=await s.json();if(a.success){this.setLoading(e,!1);let t="Reset link sent! ";a.data?.resetLink?(t="Password reset link generated! ",t+=a.data.note||"Email service is in development mode. ",t+="\n\nClick this link to reset your password:\n",t+=a.data.resetLink):t+="Please check your email (including spam folder) for instructions. The link will expire in 1 hour.",this.showSuccess(t),e.reset()}else{this.setLoading(e,!1);const t=a.data?.message||a.message||"Failed to send reset link";let s=t;t.toLowerCase().includes("not yet available")||t.toLowerCase().includes("being set up")||t.toLowerCase().includes("endpoint_not_found")?s="Password reset is currently being set up. This feature is not yet available on our backend. Please contact support for assistance or try again later.":t.toLowerCase().includes("not found")&&!t.toLowerCase().includes("account")?s="Password reset endpoint is not available. Please contact support for assistance.":t.toLowerCase().includes("not found")||t.toLowerCase().includes("does not exist")?s="No account found with this email address. Please check the spelling or sign up for a new account.":t.toLowerCase().includes("too many")||t.toLowerCase().includes("rate limit")?s="Too many reset requests. Please wait 15 minutes before requesting another password reset.":t.toLowerCase().includes("temporarily unavailable")||t.toLowerCase().includes("unable to connect")?s="The service is temporarily unavailable. Please try again in a few minutes.":(t.toLowerCase().includes("not implemented")||t.toLowerCase().includes("404")||t.toLowerCase().includes("endpoint"))&&(s="Password reset is currently being set up. Please contact support or try again later."),this.showError(s)}}catch(t){console.error("Forgot password error:",t);let s="Network error. Please try again.";"TypeError"===t.name&&t.message.includes("fetch")?s="Unable to connect to the server. Please check your internet connection and try again. If the problem persists, the service may be temporarily unavailable.":t.message&&t.message.includes("timeout")&&(s="Request timed out. Please check your internet connection and try again."),this.showError(s),this.setLoading(e,!1)}}async handleResetPassword(){const e=document.getElementById("reset-password-form"),t=new FormData(e),s=t.get("email"),a=t.get("token"),o=t.get("password");if(o===t.get("confirmPassword"))if(o.length<8)this.showError("Password must be at least 8 characters long");else{if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const t=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_reset_password",email:s,token:a,password:o,nonce:window.alttextai_ajax.nonce})});if(!t.ok){let s;try{s=await t.json()}catch(e){s={message:`Server error (${t.status})`}}this.setLoading(e,!1);const a=s.data?.message||s.message||`Request failed with status ${t.status}`;return void this.showError(a)}const r=await t.json();if(r.success)this.setLoading(e,!1),this.showSuccess("Password reset successfully! Redirecting to sign in..."),e.reset(),r.data?.redirect?setTimeout(()=>{window.location.href=r.data.redirect},1500):setTimeout(()=>{this.showLoginForm(),setTimeout(()=>{window.location.reload()},1e3)},2e3);else{this.setLoading(e,!1);const t=r.data?.message||r.message||"Failed to reset password";let s=t;t.toLowerCase().includes("expired")||t.toLowerCase().includes("invalid")&&t.toLowerCase().includes("token")?s="This password reset link has expired or is invalid. Please request a new password reset link.":t.toLowerCase().includes("token")?s="Invalid reset token. Please check the link from your email or request a new one.":t.toLowerCase().includes("password")&&t.toLowerCase().includes("weak")||t.toLowerCase().includes("strength")?s="Password is too weak. Please choose a stronger password with at least 8 characters, including letters and numbers.":t.toLowerCase().includes("network")||t.toLowerCase().includes("unable to connect")?s="Unable to connect to the server. Please check your internet connection and try again.":(t.toLowerCase().includes("not implemented")||t.toLowerCase().includes("404")||t.toLowerCase().includes("endpoint"))&&(s="Password reset is currently being set up. Please contact support or try again later."),this.showError(s)}}catch(e){console.error("Reset password error:",e);let t="Network error. Please try again.";"TypeError"===e.name&&e.message.includes("fetch")?t="Unable to connect to the server. Please check your internet connection and try again. If the problem persists, the service may be temporarily unavailable.":e.message&&e.message.includes("timeout")&&(t="Request timed out. Please check your internet connection and try again."),this.showError(t)}finally{this.setLoading(e,!1)}}else this.showError("Passwords do not match")}async checkAuthStatus(){if(this.token)try{const e=await fetch(`${this.apiUrl}/auth/me`,{headers:{Authorization:`Bearer ${this.token}`}});if(e.ok){const t=await e.json();this.onAuthSuccess(t.user)}else this.clearToken(),this.showAuthRequired()}catch(e){this.clearToken(),this.showAuthRequired()}else this.showAuthRequired()}showAuthRequired(){const e=document.querySelector("[data-auth-required]");e&&e.addEventListener("click",e=>{e.preventDefault(),this.show()})}onAuthSuccess(e){this.updateUserDisplay(e),document.dispatchEvent(new CustomEvent("alttext:auth-success",{detail:{user:e,token:this.token}}))}updateUserDisplay(e){document.querySelectorAll("[data-user-email]").forEach(t=>t.textContent=e.email),document.querySelectorAll("[data-user-plan]").forEach(t=>t.textContent=e.plan),document.querySelectorAll("[data-user-tokens]").forEach(t=>t.textContent=e.tokensRemaining)}storeToken(e){localStorage.setItem("alttextai_token",e),fetch(window.alttextai_ajax?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_store_token",token:e,nonce:window.alttextai_ajax?.nonce||""})})}getStoredToken(){return localStorage.getItem("alttextai_token")}clearToken(){localStorage.removeItem("alttextai_token"),this.token=null}setLoading(e,t){const s=e.querySelector('button[type="submit"]'),a=s.querySelector(".alttext-btn__text"),o=s.querySelector(".alttext-btn__spinner");t?(a.style.display="none",o.style.display="inline",s.disabled=!0):(a.style.display="inline",o.style.display="none",s.disabled=!1)}showError(e){document.querySelectorAll(".alttext-alert").forEach(e=>e.remove());const t=document.createElement("div");t.className="alttext-alert alttext-alert--error",t.textContent=e;const s=document.querySelector(".alttext-auth-modal__body");s.insertBefore(t,s.firstChild),setTimeout(()=>t.remove(),5e3)}showSuccess(e){document.querySelectorAll(".alttext-alert").forEach(e=>e.remove());const t=document.createElement("div");t.className="alttext-alert alttext-alert--success",t.textContent=e;const s=document.querySelector(".alttext-auth-modal__body");s.insertBefore(t,s.firstChild),setTimeout(()=>t.remove(),5e3)}}document.addEventListener("DOMContentLoaded",()=>{window.AltTextAuthModal=new AltTextAuthModal,window.AltTextAuthModal.init(),window.authModal=window.AltTextAuthModal}),"undefined"!=typeof module&&module.exports&&(module.exports=AltTextAuthModal);
=======
class AltTextAuthModal{constructor(){this.apiUrl=this.getApiUrl(),this.token=this.getStoredToken(),this.modalElement=null,this.formElements={},this.init()}getApiUrl(){if(window.alttextai_ajax?.api_url)return window.alttextai_ajax.api_url;const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"http://localhost:3001":(console.error("[AltText AI] API URL not configured"),null)}init(){this.createModalHTML(),this.modalElement=document.getElementById("alttext-auth-modal"),this.formElements={login:document.getElementById("alttext-login-form"),register:document.getElementById("alttext-register-form"),forgotPassword:document.getElementById("alttext-forgot-password-form"),resetPassword:document.getElementById("alttext-reset-password-form")},this.bindEvents(),this.checkAuthStatus(),this.checkResetPasswordParams()}checkResetPasswordParams(){const e=new URLSearchParams(window.location.search),t=e.get("reset-token"),s=e.get("email");t&&s&&(this.show(),this.showResetPasswordForm(s,t))}checkPasswordStrength(e,t){const s=e.replace("-password","-password-strength"),a=e.replace("-password","-password-strength-fill"),o=e.replace("-password","-password-strength-label"),r=e.replace("-password","-password-hint"),n=document.getElementById(s),i=document.getElementById(a),l=document.getElementById(o),d=document.getElementById(r);if(!n||!i||!l)return;if(!t||0===t.length)return n.style.display="none",void(d&&(d.style.display="block"));n.style.display="block",d&&(d.style.display="none");let c=0,m="",u="";t.length>=8&&c++,t.length>=12&&c++,/[a-z]/.test(t)&&/[A-Z]/.test(t)&&c++,/\d/.test(t)&&c++,/[^a-zA-Z\d]/.test(t)&&c++,c<=1?(m="Weak",u="#ef4444",i.style.width="25%"):2===c?(m="Fair",u="#f59e0b",i.style.width="50%"):3===c?(m="Good",u="#3b82f6",i.style.width="75%"):(m="Strong",u="#10b981",i.style.width="100%"),i.style.backgroundColor=u,l.textContent=m,l.style.color=u}createModalHTML(){document.body.insertAdjacentHTML("beforeend",'\n            <div id="alttext-auth-modal" class="alttext-auth-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="alttext-auth-modal-title" aria-describedby="alttext-auth-modal-desc">\n                <div class="alttext-auth-modal__overlay">\n                    <div class="alttext-auth-modal__content">\n                        <div class="alttext-auth-modal__header">\n                            <h2 class="alttext-auth-modal__title" id="alttext-auth-modal-title">SEO AI Alt Text Account</h2>\n                            <button class="alttext-auth-modal__close" type="button" aria-label="Close dialog">&times;</button>\n                        </div>\n                        \n                        <div class="alttext-auth-modal__body">\n                            \x3c!-- Login Form --\x3e\n                            <div id="alttext-login-form" class="alttext-auth-form">\n                                <h3>Sign In</h3>\n                                <form id="login-form" autocomplete="on" aria-label="Sign in to your SEO AI Alt Text account">\n                                    <div class="alttext-form-group">\n                                        <label for="login-email">Email</label>\n                                        <input type="email" id="login-email" name="email" autocomplete="username" required aria-required="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="login-password">Password</label>\n                                        <input type="password" id="login-password" name="password" autocomplete="current-password" required aria-required="true">\n                                        <a href="#" id="show-forgot-password" class="alttext-forgot-password-link" aria-label="Reset your password">Forgot password?</a>\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Sign in">\n                                        <span class="alttext-btn__text">Sign In</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Don\'t have an account?\n                                    <a href="#" id="show-register" aria-label="Switch to registration form">Create one here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Register Form --\x3e\n                            <div id="alttext-register-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Create Account</h3>\n                                <form id="register-form" autocomplete="off" aria-label="Create a new SEO AI Alt Text account">\n                                    <div class="alttext-form-group">\n                                        <label for="register-email">Email</label>\n                                        <input type="email" id="register-email" name="email" autocomplete="off" required aria-required="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="register-password">Password</label>\n                                        <input type="password" id="register-password" name="password" autocomplete="new-password" minlength="8" required aria-required="true" aria-describedby="register-password-strength-label register-password-hint">\n                                        <div class="alttext-password-strength" id="register-password-strength" style="display: none;" role="status" aria-live="polite" aria-atomic="true">\n                                            <div class="alttext-password-strength-bar" aria-hidden="true">\n                                                <div class="alttext-password-strength-fill" id="register-password-strength-fill" aria-hidden="true"></div>\n                                            </div>\n                                            <span class="alttext-password-strength-label" id="register-password-strength-label"></span>\n                                        </div>\n                                        <small id="register-password-hint">Minimum 8 characters</small>\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="register-confirm">Confirm Password</label>\n                                        <input type="password" id="register-confirm" name="confirmPassword" autocomplete="new-password" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Create account">\n                                        <span class="alttext-btn__text">Create Account</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Already have an account?\n                                    <a href="#" id="show-login" aria-label="Switch to sign in form">Sign in here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Forgot Password Form --\x3e\n                            <div id="alttext-forgot-password-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Reset Password</h3>\n                                <p class="alttext-forgot-password-info" id="alttext-auth-modal-desc">Enter your email address and we\'ll send you a link to reset your password.</p>\n                                <form id="forgot-password-form" autocomplete="on" aria-label="Request password reset">\n                                    <div class="alttext-form-group">\n                                        <label for="forgot-email">Email</label>\n                                        <input type="email" id="forgot-email" name="email" autocomplete="username" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Send password reset link">\n                                        <span class="alttext-btn__text">Send Reset Link</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    Remember your password?\n                                    <a href="#" id="show-login-from-forgot" aria-label="Switch to sign in form">Sign in here</a>\n                                </p>\n                            </div>\n\n                            \x3c!-- Reset Password Form --\x3e\n                            <div id="alttext-reset-password-form" class="alttext-auth-form" style="display: none;">\n                                <h3>Set New Password</h3>\n                                <p class="alttext-reset-password-info">Enter your new password below.</p>\n                                <form id="reset-password-form" autocomplete="off" aria-label="Reset your password">\n                                    <div class="alttext-form-group">\n                                        <label for="reset-email">Email</label>\n                                        <input type="email" id="reset-email" name="email" autocomplete="username" required readonly aria-readonly="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-token">Reset Token</label>\n                                        <input type="text" id="reset-token" name="token" required readonly aria-readonly="true">\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-password">New Password</label>\n                                        <input type="password" id="reset-password" name="password" autocomplete="new-password" minlength="8" required aria-required="true" aria-describedby="reset-password-strength-label reset-password-hint">\n                                        <div class="alttext-password-strength" id="reset-password-strength" style="display: none;" role="status" aria-live="polite" aria-atomic="true">\n                                            <div class="alttext-password-strength-bar" aria-hidden="true">\n                                                <div class="alttext-password-strength-fill" id="reset-password-strength-fill" aria-hidden="true"></div>\n                                            </div>\n                                            <span class="alttext-password-strength-label" id="reset-password-strength-label"></span>\n                                        </div>\n                                        <small id="reset-password-hint">Minimum 8 characters</small>\n                                    </div>\n                                    <div class="alttext-form-group">\n                                        <label for="reset-confirm">Confirm New Password</label>\n                                        <input type="password" id="reset-confirm" name="confirmPassword" autocomplete="new-password" required aria-required="true">\n                                    </div>\n                                    <button type="submit" class="alttext-btn alttext-btn--primary" aria-label="Reset password">\n                                        <span class="alttext-btn__text">Reset Password</span>\n                                        <span class="alttext-btn__spinner" style="display: none;" aria-hidden="true">⏳</span>\n                                    </button>\n                                </form>\n                                <p class="alttext-auth-switch">\n                                    <a href="#" id="show-login-from-reset" aria-label="Switch to sign in form">Back to sign in</a>\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ')}bindEvents(){const e=this;document.addEventListener("click",function(t){return t.target.closest(".alttext-auth-modal__close")?(t.preventDefault(),t.stopPropagation(),void e.hide()):t.target.classList.contains("alttext-auth-modal__overlay")?void e.hide():"show-register"===t.target.id||t.target.closest("#show-register")?(t.preventDefault(),t.stopPropagation(),void e.showRegisterForm()):"show-login"===t.target.id||t.target.closest("#show-login")?(t.preventDefault(),t.stopPropagation(),void e.showLoginForm()):"show-forgot-password"===t.target.id||t.target.closest("#show-forgot-password")?(t.preventDefault(),t.stopPropagation(),void e.showForgotPasswordForm()):"show-login-from-forgot"===t.target.id||t.target.closest("#show-login-from-forgot")||"show-login-from-reset"===t.target.id||t.target.closest("#show-login-from-reset")?(t.preventDefault(),t.stopPropagation(),void e.showLoginForm()):void 0},!0),document.addEventListener("submit",function(t){return"login-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleLogin()):"register-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleRegister()):"forgot-password-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleForgotPassword()):"reset-password-form"===t.target.id?(t.preventDefault(),t.stopPropagation(),void e.handleResetPassword()):void 0},!0),document.addEventListener("keydown",function(t){if("Escape"===t.key&&e.modalElement&&"block"===e.modalElement.style.display&&e.hide(),e.modalElement&&"block"===e.modalElement.style.display){const s=e.modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=s[0],o=s[s.length-1];"Tab"===t.key&&(t.shiftKey&&document.activeElement===a?(t.preventDefault(),o.focus()):t.shiftKey||document.activeElement!==o||(t.preventDefault(),a.focus()))}}),document.addEventListener("input",function(t){"reset-password"!==t.target.id&&"register-password"!==t.target.id||e.checkPasswordStrength(t.target.id,t.target.value)})}show(){if(this.modalElement){this.modalElement.style.display="block",document.body.style.overflow="hidden";const e=this.modalElement.querySelector('input[type="email"], input[type="password"], button');e&&e.focus()}}hide(){this.modalElement&&(this.modalElement.style.display="none",document.body.style.overflow="")}showLoginForm(){this.formElements.login&&(this.formElements.login.style.display="block"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showRegisterForm(){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="block"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showForgotPasswordForm(){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="block"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="none")}showResetPasswordForm(e,t){this.formElements.login&&(this.formElements.login.style.display="none"),this.formElements.register&&(this.formElements.register.style.display="none"),this.formElements.forgotPassword&&(this.formElements.forgotPassword.style.display="none"),this.formElements.resetPassword&&(this.formElements.resetPassword.style.display="block");const s=document.getElementById("reset-email"),a=document.getElementById("reset-token");s&&e&&(s.value=e),a&&t&&(a.value=t)}async handleLogin(){const e=document.getElementById("login-form"),t=new FormData(e),s=t.get("email"),a=t.get("password");if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const e=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_login",email:s,password:a,nonce:window.alttextai_ajax.nonce})}),t=await e.json();if(t.success)t.data,this.hide(),this.showSuccess("Welcome back! You are now signed in to SEO AI Alt Text."),setTimeout(()=>{window.location.reload()},1500);else{const e=t.data?.message||t.message||"Login failed";this.showError(e)}}catch(e){console.error("Login error:",e),"TypeError"===e.name&&e.message.includes("fetch")?this.showError("Unable to connect to authentication server. The service may be temporarily unavailable. Please try again in a few minutes."):this.showError("Network error. Please try again.")}finally{this.setLoading(e,!1)}}async handleRegister(){const e=document.getElementById("register-form"),t=new FormData(e),s=t.get("email"),a=t.get("password");if(a===t.get("confirmPassword")){if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const e=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_register",email:s,password:a,nonce:window.alttextai_ajax.nonce})}),t=await e.json();if(t.success)t.data,this.hide(),this.showSuccess("Account created successfully! Welcome to SEO AI Alt Text."),setTimeout(()=>{window.location.reload()},1500);else{const e=t.data?.message||t.message||"Registration failed";this.showError(e)}}catch(e){console.error("Registration error:",e),this.showError("Network error. Please try again.")}finally{this.setLoading(e,!1)}}else this.showError("Passwords do not match")}async handleForgotPassword(){const e=document.getElementById("forgot-password-form"),t=new FormData(e).get("email");if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const s=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_forgot_password",email:t,nonce:window.alttextai_ajax.nonce})});if(!s.ok){let t;try{t=await s.json()}catch(e){t={message:`Server error (${s.status})`}}this.setLoading(e,!1);const a=t.data?.message||t.message||`Request failed with status ${s.status}`;return void this.showError(a)}const a=await s.json();if(a.success){this.setLoading(e,!1);let t="Reset link sent! ";a.data?.resetLink?(t="Password reset link generated! ",t+=a.data.note||"Email service is in development mode. ",t+="\n\nClick this link to reset your password:\n",t+=a.data.resetLink):t+="Please check your email (including spam folder) for instructions. The link will expire in 1 hour.",this.showSuccess(t),e.reset()}else{this.setLoading(e,!1);const t=a.data?.message||a.message||"Failed to send reset link";let s=t;t.toLowerCase().includes("not yet available")||t.toLowerCase().includes("being set up")||t.toLowerCase().includes("endpoint_not_found")?s="Password reset is currently being set up. This feature is not yet available on our backend. Please contact support for assistance or try again later.":t.toLowerCase().includes("not found")&&!t.toLowerCase().includes("account")?s="Password reset endpoint is not available. Please contact support for assistance.":t.toLowerCase().includes("not found")||t.toLowerCase().includes("does not exist")?s="No account found with this email address. Please check the spelling or sign up for a new account.":t.toLowerCase().includes("too many")||t.toLowerCase().includes("rate limit")?s="Too many reset requests. Please wait 15 minutes before requesting another password reset.":t.toLowerCase().includes("temporarily unavailable")||t.toLowerCase().includes("unable to connect")?s="The service is temporarily unavailable. Please try again in a few minutes.":(t.toLowerCase().includes("not implemented")||t.toLowerCase().includes("404")||t.toLowerCase().includes("endpoint"))&&(s="Password reset is currently being set up. Please contact support or try again later."),this.showError(s)}}catch(t){console.error("Forgot password error:",t);let s="Network error. Please try again.";"TypeError"===t.name&&t.message.includes("fetch")?s="Unable to connect to the server. Please check your internet connection and try again. If the problem persists, the service may be temporarily unavailable.":t.message&&t.message.includes("timeout")&&(s="Request timed out. Please check your internet connection and try again."),this.showError(s),this.setLoading(e,!1)}}async handleResetPassword(){const e=document.getElementById("reset-password-form"),t=new FormData(e),s=t.get("email"),a=t.get("token"),o=t.get("password");if(o===t.get("confirmPassword"))if(o.length<8)this.showError("Password must be at least 8 characters long");else{if(this.setLoading(e,!0),!window.alttextai_ajax?.ajaxurl)return console.error("[AltText AI] AJAX configuration not loaded"),this.showError("Configuration error. Please refresh the page and try again."),void this.setLoading(e,!1);try{const t=await fetch(window.alttextai_ajax.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_reset_password",email:s,token:a,password:o,nonce:window.alttextai_ajax.nonce})});if(!t.ok){let s;try{s=await t.json()}catch(e){s={message:`Server error (${t.status})`}}this.setLoading(e,!1);const a=s.data?.message||s.message||`Request failed with status ${t.status}`;return void this.showError(a)}const r=await t.json();if(r.success)this.setLoading(e,!1),this.showSuccess("Password reset successfully! Redirecting to sign in..."),e.reset(),r.data?.redirect?setTimeout(()=>{window.location.href=r.data.redirect},1500):setTimeout(()=>{this.showLoginForm(),setTimeout(()=>{window.location.reload()},1e3)},2e3);else{this.setLoading(e,!1);const t=r.data?.message||r.message||"Failed to reset password";let s=t;t.toLowerCase().includes("expired")||t.toLowerCase().includes("invalid")&&t.toLowerCase().includes("token")?s="This password reset link has expired or is invalid. Please request a new password reset link.":t.toLowerCase().includes("token")?s="Invalid reset token. Please check the link from your email or request a new one.":t.toLowerCase().includes("password")&&t.toLowerCase().includes("weak")||t.toLowerCase().includes("strength")?s="Password is too weak. Please choose a stronger password with at least 8 characters, including letters and numbers.":t.toLowerCase().includes("network")||t.toLowerCase().includes("unable to connect")?s="Unable to connect to the server. Please check your internet connection and try again.":(t.toLowerCase().includes("not implemented")||t.toLowerCase().includes("404")||t.toLowerCase().includes("endpoint"))&&(s="Password reset is currently being set up. Please contact support or try again later."),this.showError(s)}}catch(e){console.error("Reset password error:",e);let t="Network error. Please try again.";"TypeError"===e.name&&e.message.includes("fetch")?t="Unable to connect to the server. Please check your internet connection and try again. If the problem persists, the service may be temporarily unavailable.":e.message&&e.message.includes("timeout")&&(t="Request timed out. Please check your internet connection and try again."),this.showError(t)}finally{this.setLoading(e,!1)}}else this.showError("Passwords do not match")}async checkAuthStatus(){if(this.token)try{const e=await fetch(`${this.apiUrl}/auth/me`,{headers:{Authorization:`Bearer ${this.token}`}});if(e.ok){const t=await e.json();this.onAuthSuccess(t.user)}else this.clearToken(),this.showAuthRequired()}catch(e){this.clearToken(),this.showAuthRequired()}else this.showAuthRequired()}showAuthRequired(){const e=document.querySelector("[data-auth-required]");e&&e.addEventListener("click",e=>{e.preventDefault(),this.show()})}onAuthSuccess(e){this.updateUserDisplay(e),document.dispatchEvent(new CustomEvent("alttext:auth-success",{detail:{user:e,token:this.token}}))}updateUserDisplay(e){document.querySelectorAll("[data-user-email]").forEach(t=>t.textContent=e.email),document.querySelectorAll("[data-user-plan]").forEach(t=>t.textContent=e.plan),document.querySelectorAll("[data-user-tokens]").forEach(t=>t.textContent=e.tokensRemaining)}storeToken(e){localStorage.setItem("alttextai_token",e),fetch(window.alttextai_ajax?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"alttextai_store_token",token:e,nonce:window.alttextai_ajax?.nonce||""})})}getStoredToken(){return localStorage.getItem("alttextai_token")}clearToken(){localStorage.removeItem("alttextai_token"),this.token=null}setLoading(e,t){const s=e.querySelector('button[type="submit"]'),a=s.querySelector(".alttext-btn__text"),o=s.querySelector(".alttext-btn__spinner");t?(a.style.display="none",o.style.display="inline",s.disabled=!0):(a.style.display="inline",o.style.display="none",s.disabled=!1)}showError(e){document.querySelectorAll(".alttext-alert").forEach(e=>e.remove());const t=document.createElement("div");t.className="alttext-alert alttext-alert--error",t.textContent=e;const s=document.querySelector(".alttext-auth-modal__body");s.insertBefore(t,s.firstChild),setTimeout(()=>t.remove(),5e3)}showSuccess(e){document.querySelectorAll(".alttext-alert").forEach(e=>e.remove());const t=document.createElement("div");t.className="alttext-alert alttext-alert--success",t.textContent=e;const s=document.querySelector(".alttext-auth-modal__body");s.insertBefore(t,s.firstChild),setTimeout(()=>t.remove(),5e3)}}document.addEventListener("DOMContentLoaded",()=>{window.AltTextAuthModal=new AltTextAuthModal,window.authModal=window.AltTextAuthModal}),"undefined"!=typeof module&&module.exports&&(module.exports=AltTextAuthModal);
>>>>>>> origin/main
