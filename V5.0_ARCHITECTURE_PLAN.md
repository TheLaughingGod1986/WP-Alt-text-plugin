# v5.0 Architecture Plan: Modular Transformation

## Executive Summary

This document outlines the complete architectural transformation from the current monolithic structure to a modern, modular, service-oriented architecture (SOA). The v5.0 refactoring will ensure **all files are under 300 lines**, implement **strict separation of concerns**, and create a **reusable framework** for spinning up new WordPress plugins.

**Key Goals:**
- âœ… All PHP files under 300 lines
- âœ… All CSS files under 300 lines
- âœ… All JS files under 300 lines
- âœ… Service-oriented architecture with dependency injection
- âœ… Component-based CSS with design tokens
- âœ… ES6 modular JavaScript architecture
- âœ… Framework for rapid plugin development
- âœ… Scalable, testable, maintainable codebase

---

## Current Architecture Problems

### PHP Architecture Issues

| File | Current Lines | Over Limit | Primary Issues |
|------|--------------|------------|----------------|
| `class-bbai-core.php` | **7,750** | **26x** | God Object anti-pattern, handles authentication, licensing, generation, queue, stats, checkout, settings, AJAX, REST, WordPress hooks |
| `class-api-client-v2.php` | **2,075** | **7x** | Mixed concerns: HTTP client + business logic + data transformation |
| `class-bbai-rest-controller.php` | 552 | 1.8x | Mixed REST routing + business logic |
| `class-queue.php` | 532 | 1.8x | Queue operations + cleanup + stats |

**Critical Problems:**
1. **God Object Pattern**: `class-bbai-core.php` violates Single Responsibility Principle
2. **Tight Coupling**: Services cannot be tested or reused independently
3. **No Dependency Injection**: Hard-coded dependencies make testing impossible
4. **Mixed Concerns**: Business logic mixed with presentation, routing, and data access
5. **Not Reusable**: Cannot extract components for other plugins

### CSS Architecture Issues

| File | Current Lines | Over Limit | Primary Issues |
|------|--------------|------------|----------------|
| `modern-style.css` | **6,868** | **23x** | All styles in one file, no component separation |
| `bbai-notices.css` | 445 | 1.5x | Mixed component styles |
| `bbai-dashboard.css` | 428 | 1.4x | Dashboard + cards + stats all together |
| `bbai-settings.css` | 401 | 1.3x | Settings + forms + tabs mixed |
| `bbai-modal.css` | 315 | 1.05x | Modal + overlay + animations |
| `bbai-queue.css` | 312 | 1.04x | Queue + table + status badges |

**Critical Problems:**
1. **No Component Isolation**: All styles global, high specificity conflicts
2. **No Design Tokens**: Hard-coded colors, spacing, typography throughout
3. **No CSS Modules**: Cannot scope styles to components
4. **Duplication**: Same patterns repeated across files
5. **Hard to Theme**: Cannot easily customize or extend

### JavaScript Architecture Issues

| File | Current Lines | Over Limit | Primary Issues |
|------|--------------|------------|----------------|
| `bbai-dashboard.js` | **2,153** | **7x** | Dashboard + authentication + stats + queue + modals |
| `bbai-settings.js` | 892 | 3x | Settings + forms + validation + API calls |
| `bbai-media-library.js` | 654 | 2.2x | Media library + inline generation + bulk actions |
| `bbai-bulk-generator.js` | 425 | 1.4x | Bulk generation + progress + error handling |
| `bbai-analytics.js` | 378 | 1.3x | Analytics + tracking + reporting |

**Critical Problems:**
1. **No Module System**: All code in global scope or jQuery namespace
2. **No State Management**: State scattered across multiple files
3. **Tight Coupling**: Components directly reference each other
4. **No Event System**: Communication via direct function calls
5. **Hard to Test**: Cannot unit test individual components

---

## Proposed v5.0 Architecture

### 1. PHP Service-Oriented Architecture

#### Directory Structure
```
beepbeep-ai-alt-text-generator/
â”œâ”€â”€ includes/
â”‚   â”œâ”€â”€ services/              # Business logic services (all <300 lines)
â”‚   â”‚   â”œâ”€â”€ AuthenticationService.php       (150 lines)
â”‚   â”‚   â”œâ”€â”€ LicenseService.php              (200 lines)
â”‚   â”‚   â”œâ”€â”€ GenerationService.php           (250 lines)
â”‚   â”‚   â”œâ”€â”€ QueueService.php                (150 lines)
â”‚   â”‚   â”œâ”€â”€ UsageService.php                (120 lines)
â”‚   â”‚   â”œâ”€â”€ MediaService.php                (200 lines)
â”‚   â”‚   â”œâ”€â”€ CheckoutService.php             (180 lines)
â”‚   â”‚   â”œâ”€â”€ StatsService.php                (150 lines)
â”‚   â”‚   â”œâ”€â”€ NotificationService.php         (100 lines)
â”‚   â”‚   â””â”€â”€ SettingsService.php             (120 lines)
â”‚   â”œâ”€â”€ repositories/          # Data access layer (all <200 lines)
â”‚   â”‚   â”œâ”€â”€ UserRepository.php              (150 lines)
â”‚   â”‚   â”œâ”€â”€ UsageRepository.php             (120 lines)
â”‚   â”‚   â”œâ”€â”€ QueueRepository.php             (180 lines)
â”‚   â”‚   â””â”€â”€ LogRepository.php               (150 lines)
â”‚   â”œâ”€â”€ controllers/           # HTTP controllers (all <250 lines)
â”‚   â”‚   â”œâ”€â”€ AuthController.php              (200 lines)
â”‚   â”‚   â”œâ”€â”€ LicenseController.php           (180 lines)
â”‚   â”‚   â”œâ”€â”€ GenerationController.php        (220 lines)
â”‚   â”‚   â”œâ”€â”€ QueueController.php             (150 lines)
â”‚   â”‚   â””â”€â”€ SettingsController.php          (180 lines)
â”‚   â”œâ”€â”€ api/                   # External API clients (all <250 lines)
â”‚   â”‚   â”œâ”€â”€ BeepBeepApiClient.php           (200 lines)
â”‚   â”‚   â”œâ”€â”€ OpenAIClient.php                (150 lines)
â”‚   â”‚   â””â”€â”€ StripeClient.php                (180 lines)
â”‚   â”œâ”€â”€ core/                  # Framework core (all <200 lines)
â”‚   â”‚   â”œâ”€â”€ Container.php                   (180 lines) - DI Container
â”‚   â”‚   â”œâ”€â”€ ServiceProvider.php             (100 lines) - Service registration
â”‚   â”‚   â”œâ”€â”€ Router.php                      (150 lines) - AJAX/REST routing
â”‚   â”‚   â””â”€â”€ EventBus.php                    (120 lines) - Event system
â”‚   â”œâ”€â”€ events/                # Domain events (all <100 lines)
â”‚   â”‚   â”œâ”€â”€ AltTextGenerated.php            (50 lines)
â”‚   â”‚   â”œâ”€â”€ LicenseActivated.php            (50 lines)
â”‚   â”‚   â”œâ”€â”€ UsageLimitReached.php           (50 lines)
â”‚   â”‚   â””â”€â”€ QueueJobCompleted.php           (50 lines)
â”‚   â””â”€â”€ legacy/                # Existing utilities (refactored <300 lines)
â”‚       â”œâ”€â”€ UsageTracker.php                (200 lines) - Slimmed down
â”‚       â”œâ”€â”€ DebugLog.php                    (250 lines) - Slimmed down
â”‚       â””â”€â”€ Queue.php                       (200 lines) - Slimmed down
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ views/                 # Template files (all <200 lines)
â”‚   â”‚   â”œâ”€â”€ dashboard.php                   (180 lines)
â”‚   â”‚   â”œâ”€â”€ settings.php                    (150 lines)
â”‚   â”‚   â”œâ”€â”€ queue.php                       (120 lines)
â”‚   â”‚   â””â”€â”€ components/                     # Reusable view components
â”‚   â”‚       â”œâ”€â”€ account-card.php            (80 lines)
â”‚   â”‚       â”œâ”€â”€ usage-widget.php            (60 lines)
â”‚   â”‚       â”œâ”€â”€ queue-table.php             (100 lines)
â”‚   â”‚       â””â”€â”€ stats-card.php              (70 lines)
â”‚   â””â”€â”€ class-bbai-admin.php               (250 lines) - Admin menu only
â””â”€â”€ bootstrap.php                           (150 lines) - Plugin initialization
```

#### Service Layer Design

**AuthenticationService.php** (150 lines)
```php
<?php
declare(strict_types=1);

namespace BeepBeep\AltText\Services;

use BeepBeep\AltText\Api\BeepBeepApiClient;
use BeepBeep\AltText\Events\UserLoggedIn;
use BeepBeep\AltText\Events\UserLoggedOut;
use BeepBeep\AltText\Core\EventBus;

/**
 * Handles user authentication and session management.
 *
 * @since 5.0.0
 */
class AuthenticationService {
    private BeepBeepApiClient $api_client;
    private EventBus $event_bus;

    public function __construct(
        BeepBeepApiClient $api_client,
        EventBus $event_bus
    ) {
        $this->api_client = $api_client;
        $this->event_bus = $event_bus;
    }

    /**
     * Register a new user account.
     */
    public function register(string $email, string $password): array {
        // Validation logic
        // API call
        // Store credentials
        // Return result
    }

    /**
     * Log in existing user.
     */
    public function login(string $email, string $password): array {
        // Validation
        // API authentication
        // Store session
        // Dispatch UserLoggedIn event
        // Return user data
    }

    /**
     * Log out current user.
     */
    public function logout(): void {
        // Clear session
        // Dispatch UserLoggedOut event
    }

    /**
     * Check if user is authenticated.
     */
    public function isAuthenticated(): bool {
        // Check session/credentials
    }

    /**
     * Get current user data.
     */
    public function getCurrentUser(): ?array {
        // Return user data or null
    }
}
```

**LicenseService.php** (200 lines)
```php
<?php
declare(strict_types=1);

namespace BeepBeep\AltText\Services;

use BeepBeep\AltText\Api\BeepBeepApiClient;
use BeepBeep\AltText\Events\LicenseActivated;
use BeepBeep\AltText\Events\LicenseDeactivated;
use BeepBeep\AltText\Core\EventBus;

/**
 * Manages license activation and organization features.
 *
 * @since 5.0.0
 */
class LicenseService {
    private BeepBeepApiClient $api_client;
    private EventBus $event_bus;

    public function __construct(
        BeepBeepApiClient $api_client,
        EventBus $event_bus
    ) {
        $this->api_client = $api_client;
        $this->event_bus = $event_bus;
    }

    /**
     * Activate license key for this site.
     */
    public function activate(string $license_key): array {
        // Validate key format
        // Call API to activate
        // Store license data locally
        // Dispatch LicenseActivated event
        // Return organization data
    }

    /**
     * Deactivate license for this site.
     */
    public function deactivate(): array {
        // Get current license
        // Call API to deactivate
        // Clear local license data
        // Dispatch LicenseDeactivated event
        // Return result
    }

    /**
     * Check if license is active.
     */
    public function hasActiveLicense(): bool {
        // Check stored license data
        // Verify expiration
    }

    /**
     * Get license organization data.
     */
    public function getOrganization(): ?array {
        // Return org data or null
    }

    /**
     * Get all sites using this license.
     */
    public function getLicenseSites(): array {
        // API call to get sites
    }

    /**
     * Disconnect a site from license.
     */
    public function disconnectSite(int $site_id): array {
        // API call to disconnect
    }
}
```

**GenerationService.php** (250 lines)
```php
<?php
declare(strict_types=1);

namespace BeepBeep\AltText\Services;

use BeepBeep\AltText\Api\BeepBeepApiClient;
use BeepBeep\AltText\Events\AltTextGenerated;
use BeepBeep\AltText\Core\EventBus;
use WP_Post;

/**
 * Handles alt text generation for media attachments.
 *
 * @since 5.0.0
 */
class GenerationService {
    private BeepBeepApiClient $api_client;
    private UsageService $usage_service;
    private EventBus $event_bus;

    public function __construct(
        BeepBeepApiClient $api_client,
        UsageService $usage_service,
        EventBus $event_bus
    ) {
        $this->api_client = $api_client;
        $this->usage_service = $usage_service;
        $this->event_bus = $event_bus;
    }

    /**
     * Generate alt text for single attachment.
     */
    public function generateForAttachment(int $attachment_id): array {
        // Validate attachment exists
        // Check usage limits
        // Get image URL
        // Call API
        // Save alt text to post meta
        // Update usage
        // Dispatch AltTextGenerated event
        // Return result
    }

    /**
     * Generate alt text inline (synchronous).
     */
    public function generateInline(int $attachment_id): array {
        // Same as above but with timeout handling
    }

    /**
     * Regenerate alt text (overwrite existing).
     */
    public function regenerate(int $attachment_id): array {
        // Clear existing alt text
        // Generate new alt text
    }

    /**
     * Validate attachment can be processed.
     */
    private function canProcess(WP_Post $attachment): bool {
        // Check if image
        // Check if URL accessible
        // Check file size
    }

    /**
     * Extract image URL from attachment.
     */
    private function getImageUrl(int $attachment_id): ?string {
        // Get full size URL
        // Fallback to largest available
    }
}
```

#### Dependency Injection Container

**Container.php** (180 lines)
```php
<?php
declare(strict_types=1);

namespace BeepBeep\AltText\Core;

/**
 * Simple dependency injection container.
 *
 * Manages service instantiation and dependency resolution.
 *
 * @since 5.0.0
 */
class Container {
    private array $services = [];
    private array $instances = [];

    /**
     * Register a service.
     */
    public function register(string $name, callable $factory): void {
        $this->services[$name] = $factory;
    }

    /**
     * Register a singleton service.
     */
    public function singleton(string $name, callable $factory): void {
        $this->register($name, function() use ($name, $factory) {
            if (!isset($this->instances[$name])) {
                $this->instances[$name] = $factory($this);
            }
            return $this->instances[$name];
        });
    }

    /**
     * Get a service instance.
     */
    public function get(string $name) {
        if (!isset($this->services[$name])) {
            throw new \Exception("Service {$name} not found");
        }
        return $this->services[$name]($this);
    }

    /**
     * Check if service exists.
     */
    public function has(string $name): bool {
        return isset($this->services[$name]);
    }
}
```

**ServiceProvider.php** (100 lines)
```php
<?php
declare(strict_types=1);

namespace BeepBeep\AltText\Core;

use BeepBeep\AltText\Services\*;
use BeepBeep\AltText\Api\*;

/**
 * Registers all services with the DI container.
 *
 * @since 5.0.0
 */
class ServiceProvider {
    public static function register(Container $container): void {
        // Register API clients
        $container->singleton('api.beepbeep', fn($c) => new BeepBeepApiClient());
        $container->singleton('api.stripe', fn($c) => new StripeClient());

        // Register event bus
        $container->singleton('event_bus', fn($c) => new EventBus());

        // Register services
        $container->singleton('auth', fn($c) => new AuthenticationService(
            $c->get('api.beepbeep'),
            $c->get('event_bus')
        ));

        $container->singleton('license', fn($c) => new LicenseService(
            $c->get('api.beepbeep'),
            $c->get('event_bus')
        ));

        $container->singleton('usage', fn($c) => new UsageService(
            $c->get('api.beepbeep')
        ));

        $container->singleton('generation', fn($c) => new GenerationService(
            $c->get('api.beepbeep'),
            $c->get('usage'),
            $c->get('event_bus')
        ));

        // ... register all other services
    }
}
```

---

### 2. CSS Component Architecture

#### Directory Structure
```
assets/css/
â”œâ”€â”€ tokens/                    # Design system tokens
â”‚   â”œâ”€â”€ colors.css            (80 lines) - Color palette
â”‚   â”œâ”€â”€ typography.css        (60 lines) - Font system
â”‚   â”œâ”€â”€ spacing.css           (50 lines) - Spacing scale
â”‚   â”œâ”€â”€ shadows.css           (40 lines) - Shadow system
â”‚   â””â”€â”€ animations.css        (70 lines) - Animation system
â”œâ”€â”€ base/                      # Foundation styles
â”‚   â”œâ”€â”€ reset.css             (100 lines) - CSS reset
â”‚   â”œâ”€â”€ utilities.css         (150 lines) - Utility classes
â”‚   â””â”€â”€ layout.css            (120 lines) - Grid/flexbox utilities
â”œâ”€â”€ components/                # Reusable components (all <200 lines)
â”‚   â”œâ”€â”€ button.css            (120 lines)
â”‚   â”œâ”€â”€ card.css              (150 lines)
â”‚   â”œâ”€â”€ modal.css             (180 lines)
â”‚   â”œâ”€â”€ form.css              (200 lines)
â”‚   â”œâ”€â”€ table.css             (180 lines)
â”‚   â”œâ”€â”€ badge.css             (80 lines)
â”‚   â”œâ”€â”€ progress.css          (100 lines)
â”‚   â”œâ”€â”€ tabs.css              (140 lines)
â”‚   â”œâ”€â”€ dropdown.css          (120 lines)
â”‚   â””â”€â”€ tooltip.css           (90 lines)
â””â”€â”€ pages/                     # Page-specific styles (all <250 lines)
    â”œâ”€â”€ dashboard.css         (200 lines)
    â”œâ”€â”€ settings.css          (180 lines)
    â”œâ”€â”€ queue.css             (150 lines)
    â””â”€â”€ billing.css           (120 lines)
```

#### Design Token System

**colors.css** (80 lines)
```css
/**
 * Color Design Tokens
 * All colors centralized for easy theming
 */
:root {
    /* Brand Colors */
    --color-primary: #2563eb;
    --color-primary-hover: #1d4ed8;
    --color-primary-light: #dbeafe;
    --color-primary-dark: #1e40af;

    /* Semantic Colors */
    --color-success: #10b981;
    --color-success-light: #d1fae5;
    --color-warning: #f59e0b;
    --color-warning-light: #fef3c7;
    --color-error: #ef4444;
    --color-error-light: #fee2e2;
    --color-info: #3b82f6;
    --color-info-light: #dbeafe;

    /* Neutral Palette */
    --color-gray-50: #f9fafb;
    --color-gray-100: #f3f4f6;
    --color-gray-200: #e5e7eb;
    --color-gray-300: #d1d5db;
    --color-gray-400: #9ca3af;
    --color-gray-500: #6b7280;
    --color-gray-600: #4b5563;
    --color-gray-700: #374151;
    --color-gray-800: #1f2937;
    --color-gray-900: #111827;

    /* Surface Colors */
    --color-bg-primary: #ffffff;
    --color-bg-secondary: var(--color-gray-50);
    --color-bg-tertiary: var(--color-gray-100);

    /* Text Colors */
    --color-text-primary: var(--color-gray-900);
    --color-text-secondary: var(--color-gray-600);
    --color-text-tertiary: var(--color-gray-500);

    /* Border Colors */
    --color-border: var(--color-gray-200);
    --color-border-hover: var(--color-gray-300);
}
```

**spacing.css** (50 lines)
```css
/**
 * Spacing Design Tokens
 * Consistent spacing scale based on 4px baseline
 */
:root {
    --space-0: 0;
    --space-1: 0.25rem;  /* 4px */
    --space-2: 0.5rem;   /* 8px */
    --space-3: 0.75rem;  /* 12px */
    --space-4: 1rem;     /* 16px */
    --space-5: 1.25rem;  /* 20px */
    --space-6: 1.5rem;   /* 24px */
    --space-8: 2rem;     /* 32px */
    --space-10: 2.5rem;  /* 40px */
    --space-12: 3rem;    /* 48px */
    --space-16: 4rem;    /* 64px */
    --space-20: 5rem;    /* 80px */
    --space-24: 6rem;    /* 96px */
}
```

#### Component Example

**button.css** (120 lines)
```css
/**
 * Button Component
 * Reusable button styles with variants
 *
 * @since 5.0.0
 */

/* Base Button */
.bbai-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
    border: 1px solid transparent;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.bbai-btn:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
}

.bbai-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Primary Variant */
.bbai-btn--primary {
    background-color: var(--color-primary);
    color: #ffffff;
}

.bbai-btn--primary:hover:not(:disabled) {
    background-color: var(--color-primary-hover);
}

/* Secondary Variant */
.bbai-btn--secondary {
    background-color: transparent;
    border-color: var(--color-border);
    color: var(--color-text-primary);
}

.bbai-btn--secondary:hover:not(:disabled) {
    background-color: var(--color-gray-50);
}

/* Danger Variant */
.bbai-btn--danger {
    background-color: var(--color-error);
    color: #ffffff;
}

.bbai-btn--danger:hover:not(:disabled) {
    background-color: #dc2626;
}

/* Size Variants */
.bbai-btn--sm {
    padding: var(--space-2) var(--space-3);
    font-size: 0.75rem;
}

.bbai-btn--lg {
    padding: var(--space-4) var(--space-6);
    font-size: 1rem;
}

/* Loading State */
.bbai-btn--loading {
    position: relative;
    color: transparent;
}

.bbai-btn--loading::after {
    content: '';
    position: absolute;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
```

---

### 3. JavaScript Module Architecture

#### Directory Structure
```
assets/js/
â”œâ”€â”€ core/                      # Framework core (all <200 lines)
â”‚   â”œâ”€â”€ EventBus.js           (120 lines) - Event system
â”‚   â”œâ”€â”€ Store.js              (180 lines) - State management
â”‚   â”œâ”€â”€ Router.js             (150 lines) - Client-side routing
â”‚   â””â”€â”€ Http.js               (200 lines) - HTTP client with nonce
â”œâ”€â”€ services/                  # API services (all <150 lines)
â”‚   â”œâ”€â”€ AuthService.js        (120 lines)
â”‚   â”œâ”€â”€ GenerationService.js  (140 lines)
â”‚   â”œâ”€â”€ QueueService.js       (100 lines)
â”‚   â”œâ”€â”€ UsageService.js       (80 lines)
â”‚   â””â”€â”€ LicenseService.js     (130 lines)
â”œâ”€â”€ components/                # UI components (all <200 lines)
â”‚   â”œâ”€â”€ AccountCard.js        (150 lines)
â”‚   â”œâ”€â”€ UsageWidget.js        (120 lines)
â”‚   â”œâ”€â”€ QueueTable.js         (180 lines)
â”‚   â”œâ”€â”€ StatsCard.js          (100 lines)
â”‚   â”œâ”€â”€ Modal.js              (200 lines)
â”‚   â”œâ”€â”€ Toast.js              (90 lines)
â”‚   â””â”€â”€ ProgressBar.js        (80 lines)
â”œâ”€â”€ pages/                     # Page controllers (all <250 lines)
â”‚   â”œâ”€â”€ DashboardPage.js      (220 lines)
â”‚   â”œâ”€â”€ SettingsPage.js       (180 lines)
â”‚   â”œâ”€â”€ QueuePage.js          (150 lines)
â”‚   â””â”€â”€ BillingPage.js        (140 lines)
â””â”€â”€ app.js                     (100 lines) - Application bootstrap
```

#### Event Bus System

**EventBus.js** (120 lines)
```javascript
/**
 * Event Bus for decoupled component communication.
 *
 * @since 5.0.0
 */
export class EventBus {
    constructor() {
        this.listeners = new Map();
    }

    /**
     * Subscribe to an event.
     *
     * @param {string} event - Event name
     * @param {Function} callback - Event handler
     * @returns {Function} Unsubscribe function
     */
    on(event, callback) {
        if (!this.listeners.has(event)) {
            this.listeners.set(event, new Set());
        }

        this.listeners.get(event).add(callback);

        // Return unsubscribe function
        return () => {
            this.listeners.get(event)?.delete(callback);
        };
    }

    /**
     * Subscribe to event once.
     *
     * @param {string} event - Event name
     * @param {Function} callback - Event handler
     */
    once(event, callback) {
        const unsubscribe = this.on(event, (...args) => {
            callback(...args);
            unsubscribe();
        });
    }

    /**
     * Emit an event.
     *
     * @param {string} event - Event name
     * @param {*} data - Event data
     */
    emit(event, data) {
        const callbacks = this.listeners.get(event);
        if (callbacks) {
            callbacks.forEach(callback => {
                try {
                    callback(data);
                } catch (error) {
                    console.error(`Error in event listener for ${event}:`, error);
                }
            });
        }
    }

    /**
     * Remove all listeners for an event.
     *
     * @param {string} event - Event name
     */
    off(event) {
        this.listeners.delete(event);
    }

    /**
     * Clear all event listeners.
     */
    clear() {
        this.listeners.clear();
    }
}

// Create global instance
export const eventBus = new EventBus();
```

#### State Management

**Store.js** (180 lines)
```javascript
/**
 * Simple state management store.
 *
 * @since 5.0.0
 */
export class Store {
    constructor(initialState = {}) {
        this.state = initialState;
        this.listeners = new Set();
        this.middlewares = [];
    }

    /**
     * Get current state.
     *
     * @returns {Object} Current state
     */
    getState() {
        return { ...this.state };
    }

    /**
     * Update state.
     *
     * @param {Object|Function} updates - State updates or updater function
     */
    setState(updates) {
        const prevState = this.getState();

        // Support both object and function updates
        const nextState = typeof updates === 'function'
            ? updates(prevState)
            : { ...prevState, ...updates };

        // Run middlewares
        let finalState = nextState;
        for (const middleware of this.middlewares) {
            finalState = middleware(prevState, finalState, this);
        }

        this.state = finalState;

        // Notify listeners
        this.listeners.forEach(listener => {
            listener(finalState, prevState);
        });
    }

    /**
     * Subscribe to state changes.
     *
     * @param {Function} listener - State change callback
     * @returns {Function} Unsubscribe function
     */
    subscribe(listener) {
        this.listeners.add(listener);

        // Return unsubscribe function
        return () => {
            this.listeners.delete(listener);
        };
    }

    /**
     * Add middleware.
     *
     * @param {Function} middleware - Middleware function
     */
    use(middleware) {
        this.middlewares.push(middleware);
    }
}

// Create global store
export const store = new Store({
    user: null,
    license: null,
    usage: null,
    queue: {
        stats: {},
        jobs: []
    },
    ui: {
        loading: false,
        error: null
    }
});
```

#### Service Example

**AuthService.js** (120 lines)
```javascript
/**
 * Authentication service.
 *
 * @since 5.0.0
 */
import { Http } from '../core/Http.js';
import { eventBus } from '../core/EventBus.js';
import { store } from '../core/Store.js';

export class AuthService {
    constructor() {
        this.http = new Http();
    }

    /**
     * Register new user.
     *
     * @param {string} email - User email
     * @param {string} password - User password
     * @returns {Promise<Object>} User data
     */
    async register(email, password) {
        try {
            const response = await this.http.post('bbai_register', {
                email,
                password
            });

            if (response.success) {
                store.setState({ user: response.data.user });
                eventBus.emit('user:registered', response.data);
            }

            return response;
        } catch (error) {
            eventBus.emit('user:register-failed', error);
            throw error;
        }
    }

    /**
     * Log in user.
     *
     * @param {string} email - User email
     * @param {string} password - User password
     * @returns {Promise<Object>} User data
     */
    async login(email, password) {
        try {
            const response = await this.http.post('bbai_login', {
                email,
                password
            });

            if (response.success) {
                store.setState({ user: response.data.user });
                eventBus.emit('user:logged-in', response.data);
            }

            return response;
        } catch (error) {
            eventBus.emit('user:login-failed', error);
            throw error;
        }
    }

    /**
     * Log out user.
     *
     * @returns {Promise<void>}
     */
    async logout() {
        try {
            await this.http.post('bbai_logout');
            store.setState({ user: null, license: null });
            eventBus.emit('user:logged-out');
        } catch (error) {
            eventBus.emit('user:logout-failed', error);
            throw error;
        }
    }

    /**
     * Check if user is authenticated.
     *
     * @returns {boolean}
     */
    isAuthenticated() {
        const { user } = store.getState();
        return user !== null;
    }
}

export const authService = new AuthService();
```

---

## Migration Strategy

### Phase 1: Foundation (Week 1)

**Goal**: Set up new architecture without breaking existing functionality.

1. **Create new directory structure**
   - `includes/services/`
   - `includes/repositories/`
   - `includes/controllers/`
   - `includes/core/`
   - `assets/css/tokens/`, `assets/css/components/`
   - `assets/js/core/`, `assets/js/services/`

2. **Implement core framework**
   - Container.php (DI container)
   - ServiceProvider.php
   - EventBus.php (PHP)
   - EventBus.js (JavaScript)
   - Store.js (State management)
   - Design token CSS files

3. **Move existing utilities to legacy/**
   - Keep them working
   - Plan for gradual replacement

### Phase 2: Service Extraction (Week 2-3)

**Goal**: Extract services from class-bbai-core.php one at a time.

**Order of extraction:**

1. **AuthenticationService** (150 lines)
   - Extract `ajax_register()`, `ajax_login()`, `ajax_logout()`
   - Test authentication flows
   - Switch controllers to use new service

2. **LicenseService** (200 lines)
   - Extract `ajax_activate_license()`, `ajax_deactivate_license()`
   - Extract license site management
   - Test license activation/deactivation

3. **UsageService** (120 lines)
   - Extract usage tracking logic
   - Integrate with UsageTracker legacy class
   - Test usage updates

4. **GenerationService** (250 lines)
   - Extract `ajax_inline_generate()`, `ajax_regenerate_single()`
   - Extract generation logic
   - Test alt text generation

5. **QueueService** (150 lines)
   - Extract queue management
   - Integrate with Queue legacy class
   - Test background processing

6. **Continue for all remaining services...**

### Phase 3: Controller Layer (Week 4)

**Goal**: Create thin controllers that delegate to services.

1. **AuthController** - Handle authentication endpoints
2. **LicenseController** - Handle license endpoints
3. **GenerationController** - Handle generation endpoints
4. **QueueController** - Handle queue endpoints
5. **SettingsController** - Handle settings endpoints

### Phase 4: Frontend Refactor (Week 5-6)

**Goal**: Modularize CSS and JavaScript.

**CSS Migration:**
1. Extract design tokens to `tokens/` directory
2. Create component CSS files (button, card, modal, etc.)
3. Convert page CSS to use components and tokens
4. Remove `modern-style.css` monolith

**JavaScript Migration:**
1. Implement EventBus and Store
2. Create service modules (AuthService.js, etc.)
3. Create component modules (AccountCard.js, etc.)
4. Convert page scripts to use services and components
5. Remove monolithic `bbai-dashboard.js`

### Phase 5: Testing & Optimization (Week 7)

1. **Unit tests** for all services
2. **Integration tests** for workflows
3. **Performance testing**
4. **Code coverage** analysis
5. **Final cleanup** and documentation

### Phase 6: Plugin Framework (Week 8)

**Goal**: Create reusable framework for rapid plugin development.

1. **Create plugin boilerplate generator**
   - Service layer template
   - Controller template
   - View templates
   - CSS component library
   - JS module library

2. **Extract shared components to framework package**
   - Container, ServiceProvider, EventBus
   - Base services (Auth, API, Settings)
   - UI components (Modal, Toast, Card)
   - Design token system

3. **Document framework usage**
   - Quick start guide
   - Service creation guide
   - Component development guide
   - Theming guide

---

## File Size Verification

### PHP Files (Target: <300 lines)

| Service/Class | Estimated Lines | Status |
|---------------|----------------|---------|
| AuthenticationService | 150 | âœ… |
| LicenseService | 200 | âœ… |
| GenerationService | 250 | âœ… |
| QueueService | 150 | âœ… |
| UsageService | 120 | âœ… |
| MediaService | 200 | âœ… |
| CheckoutService | 180 | âœ… |
| StatsService | 150 | âœ… |
| NotificationService | 100 | âœ… |
| SettingsService | 120 | âœ… |
| Container | 180 | âœ… |
| ServiceProvider | 100 | âœ… |
| Router | 150 | âœ… |
| EventBus | 120 | âœ… |
| All Controllers | <250 each | âœ… |
| All Repositories | <200 each | âœ… |

**Total PHP Reduction:**
- Before: 7,750 lines in one file
- After: 10 services Ã— ~160 lines avg = 1,600 lines
- **Reduction: 79% smaller total, 100% modular**

### CSS Files (Target: <300 lines)

| File | Estimated Lines | Status |
|------|----------------|---------|
| Design tokens (5 files) | <80 each | âœ… |
| Base styles (3 files) | <150 each | âœ… |
| Components (10 files) | <200 each | âœ… |
| Pages (4 files) | <250 each | âœ… |

**Total CSS Reduction:**
- Before: 6,868 lines in one file
- After: 22 files Ã— ~120 lines avg = 2,640 lines
- **Reduction: 62% smaller total, 100% modular**

### JavaScript Files (Target: <300 lines)

| File | Estimated Lines | Status |
|------|----------------|---------|
| Core modules (4 files) | <200 each | âœ… |
| Services (5 files) | <150 each | âœ… |
| Components (7 files) | <200 each | âœ… |
| Pages (4 files) | <250 each | âœ… |

**Total JavaScript Reduction:**
- Before: 2,153 lines in one file
- After: 20 files Ã— ~150 lines avg = 3,000 lines
- **Reduction: More code but 100% modular and testable**

---

## Benefits of v5.0 Architecture

### 1. Modularity
- âœ… Every file under 300 lines
- âœ… Single Responsibility Principle enforced
- âœ… Easy to navigate and understand
- âœ… Clear separation of concerns

### 2. Testability
- âœ… Services can be unit tested in isolation
- âœ… Dependencies can be mocked via DI
- âœ… Components have clear interfaces
- âœ… Integration tests are straightforward

### 3. Reusability
- âœ… Services can be reused across plugins
- âœ… CSS components are portable
- âœ… JavaScript modules are framework-agnostic
- âœ… Design tokens enable consistent branding

### 4. Scalability
- âœ… Adding features doesn't grow file sizes
- âœ… New services are isolated additions
- âœ… Performance is optimized per module
- âœ… Can lazy-load components

### 5. Maintainability
- âœ… Changes are isolated to single files
- âœ… Clear ownership of responsibilities
- âœ… Easy to onboard new developers
- âœ… Self-documenting structure

### 6. Developer Experience
- âœ… Fast file navigation
- âœ… Clear mental model
- âœ… Autocomplete works better
- âœ… IDE performance improved

### 7. Plugin Framework
- âœ… Can spin up new plugins in hours, not weeks
- âœ… Consistent look and feel across products
- âœ… Shared component library
- âœ… Unified authentication system
- âœ… Common design language

---

## Success Metrics

After v5.0 completion, we should achieve:

### Code Quality Metrics
- [ ] **100%** of files under 300 lines
- [ ] **100%** type coverage (already at 80%+)
- [ ] **90%+** unit test coverage
- [ ] **100%** integration test coverage
- [ ] **0** WordPress coding standard violations

### Architecture Metrics
- [ ] **10+** isolated services
- [ ] **10+** reusable CSS components
- [ ] **15+** reusable JS modules
- [ ] **100%** dependency injection usage
- [ ] **0** global state (except DI container)

### Performance Metrics
- [ ] **<100ms** admin page load (from Service Worker)
- [ ] **<200ms** AJAX response times
- [ ] **<50KB** minified CSS bundle
- [ ] **<100KB** minified JS bundle
- [ ] **A** grade on WebPageTest

### Developer Experience Metrics
- [ ] **<5 minutes** to locate and modify any feature
- [ ] **<1 hour** to add new service
- [ ] **<30 minutes** to add new component
- [ ] **<1 day** to onboard new developer
- [ ] **<1 week** to spin up new plugin from framework

---

## Next Steps

1. **Review this plan** - Ensure all stakeholders agree on architecture
2. **Create PR for v4.4** - Lock in current type safety gains
3. **Get approval** - Confirm v5.0 transformation is approved
4. **Begin Phase 1** - Set up new directory structure and core framework
5. **Iterate through phases** - Extract services one by one
6. **Test rigorously** - Maintain 100% test coverage throughout
7. **Deploy v5.0** - Launch modular architecture
8. **Build framework** - Extract reusable components for future plugins

---

## Conclusion

The v5.0 transformation will convert this WordPress plugin from a monolithic architecture to a modern, modular, service-oriented system that follows best practices and enables rapid development of future plugins.

**Key Outcomes:**
- ðŸŽ¯ All files under 300 lines
- ðŸŽ¯ Service-oriented architecture
- ðŸŽ¯ Component-based frontend
- ðŸŽ¯ 100% dependency injection
- ðŸŽ¯ Reusable plugin framework
- ðŸŽ¯ Scalable, testable, maintainable

This architecture will serve as the foundation for a family of WordPress plugins sharing a common framework, design system, and authentication layer.
