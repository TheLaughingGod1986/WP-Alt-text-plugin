# üöÄ v4.3 ‚Üí v5.0 Implementation Guide

**Comprehensive refactoring roadmap with code examples**

---

## ‚ö° v4.3 Quick Wins (2-4 hours)

### 1. Fix Yoda Conditions ‚úÖ

**Files to Update:**
- `beepbeep-ai-alt-text-generator/includes/class-queue.php`
- `beepbeep-ai-alt-text-generator/includes/class-debug-log.php`
- `beepbeep-ai-alt-text-generator/includes/class-usage-tracker.php`

**Pattern:**
```php
// ‚ùå BEFORE (Non-Yoda):
if ($status == 'pending') {
if ($user_id != 0) {
if ($result === false) {

// ‚úÖ AFTER (Yoda):
if ('pending' === $status) {
if (0 !== $user_id) {
if (false === $result) {
```

**Quick Find & Replace:**
```bash
# Find all non-Yoda conditions:
grep -rn "if.*\$.*==" includes/

# Manual fix each occurrence
```

---

### 2. Add PHPDoc to Critical Methods ‚úÖ

**Priority: Public API Methods First**

#### Example 1: `generate_and_save()` in class-bbai-core.php

**BEFORE:**
```php
public function generate_and_save($attachment_id, $source = 'manual') {
    $id = absint($attachment_id);
    // ...
}
```

**AFTER:**
```php
/**
 * Generate and save alt text for an attachment.
 *
 * Processes an image through the AI service to generate descriptive
 * alt text, then saves it to the attachment's metadata.
 *
 * @since 4.2.3
 * @since 4.3.0 Added type hints and improved documentation.
 *
 * @param int    $attachment_id WordPress attachment post ID.
 * @param string $source        Generation source: 'manual', 'auto', 'bulk', 'upload', or 'ajax'.
 *
 * @return string|WP_Error Generated alt text string on success, WP_Error object on failure.
 *
 * @throws \InvalidArgumentException If attachment ID is invalid.
 *
 * @example
 * ```php
 * $result = $core->generate_and_save(123, 'manual');
 * if (is_wp_error($result)) {
 *     error_log($result->get_error_message());
 * }
 * ```
 */
public function generate_and_save(int $attachment_id, string $source = 'manual') {
    $id = absint($attachment_id);
    // ...
}
```

#### Example 2: `ajax_login()` in class-bbai-core.php

**BEFORE:**
```php
public function ajax_login() {
    check_ajax_referer('beepbeepai_nonce', 'nonce');
    // ...
}
```

**AFTER:**
```php
/**
 * Handle AJAX login request.
 *
 * Processes user login via AJAX, authenticates against the backend API,
 * stores the auth token, and returns account information.
 *
 * @since 4.2.3
 * @since 4.3.0 Added comprehensive documentation.
 *
 * @return void Outputs JSON response via wp_send_json_success() or wp_send_json_error().
 *
 * @see wp_send_json_success()
 * @see wp_send_json_error()
 *
 * @global wpdb $wpdb WordPress database abstraction object.
 */
public function ajax_login(): void {
    check_ajax_referer('beepbeepai_nonce', 'nonce');
    // ...
}
```

#### Example 3: `get_usage()` in class-api-client-v2.php

**BEFORE:**
```php
public function get_usage() {
    // ...
}
```

**AFTER:**
```php
/**
 * Retrieve usage statistics from the backend API.
 *
 * Fetches current credit usage, limits, and plan information
 * for the authenticated user or license.
 *
 * @since 4.2.3
 * @since 4.3.0 Added return type and documentation.
 *
 * @return array|WP_Error {
 *     Usage data array on success, WP_Error on failure.
 *
 *     @type int    $used      Number of credits used this period.
 *     @type int    $limit     Total credit limit for current plan.
 *     @type int    $remaining Remaining credits available.
 *     @type string $plan      Current plan slug ('free', 'pro', 'agency').
 *     @type float  $percentage Percentage of credits used (0-100).
 * }
 */
public function get_usage(): array|WP_Error {
    // ...
}
```

**Template for Public Methods:**
```php
/**
 * [One-line description]
 *
 * [Detailed description of what the method does,
 * including any important behavior or side effects]
 *
 * @since [version]
 *
 * @param type $param Description.
 *
 * @return type Description.
 *
 * @throws ExceptionType When this is thrown.
 *
 * @example
 * ```php
 * // Usage example
 * ```
 */
```

---

### 3. Add Type Hints to Top 10 Methods ‚úÖ

**Most-Used Methods to Type:**

#### 1. Core Generation Methods

```php
// class-bbai-core.php

public function generate_and_save(int $attachment_id, string $source = 'manual'): string|WP_Error

public function generate_bulk(array $attachment_ids, string $source = 'bulk'): array

public function user_can_manage(): bool

public function get_media_stats(bool $fresh = false): array
```

#### 2. API Client Methods

```php
// class-api-client-v2.php

public function get_usage(bool $force_refresh = false): array|WP_Error

public function login(string $email, string $password): array|WP_Error

public function is_authenticated(): bool

public function get_token(): string
```

#### 3. Usage Tracking Methods

```php
// class-usage-tracker.php

public static function update_usage(array $usage_data): bool

public static function get_cached_usage(bool $force_refresh = false): array

public static function get_stats_display(bool $force_refresh = false): array
```

#### 4. Queue Methods

```php
// class-queue.php

public static function enqueue(int $attachment_id, string $source = 'auto'): bool

public static function get_batch_to_process(int $limit = 10): array

public static function mark_completed(int $id): bool

public static function mark_failed(int $id, string $error): bool
```

---

### 4. Use Constants Class ‚úÖ

**Replace Magic Values:**

#### Before:
```php
// Scattered throughout codebase
if ($used > 50) {
    return new WP_Error('limit_reached', 'Monthly limit reached');
}

wp_schedule_single_event(time() + 30, 'bbai_process_queue');

$table = $wpdb->prefix . 'bbai_queue';
```

#### After:
```php
use BeepBeepAI\AltTextGenerator\BbAI_Constants;

if ($used > BbAI_Constants::FREE_PLAN_LIMIT) {
    return new WP_Error(
        BbAI_Constants::ERROR_LIMIT_REACHED,
        __('Monthly limit reached', BbAI_Constants::TEXT_DOMAIN)
    );
}

wp_schedule_single_event(
    time() + BbAI_Constants::QUEUE_DELAY_SECONDS,
    'bbai_process_queue'
);

$table = $wpdb->prefix . BbAI_Constants::TABLE_QUEUE;
```

---

## üìù v4.4 Type Safety (1-2 weeks)

### 1. Add Strict Types Declaration

**Add to ALL PHP files:**

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator;

if (!defined('ABSPATH')) {
    exit;
}
```

### 2. Full Type Coverage

**Target: 80%+ of all methods**

#### Parameter Types:

```php
// Before:
public function process($data, $options = [])

// After:
public function process(array $data, array $options = []): array
```

#### Return Types:

```php
// Before:
public function get_stats() {
    return $this->stats;
}

// After:
public function get_stats(): array {
    return $this->stats;
}
```

#### Nullable Types (PHP 7.1+):

```php
public function find_user(int $id): ?WP_User {
    $user = get_user_by('id', $id);
    return $user ?: null;
}
```

#### Union Types (PHP 8.0+):

```php
public function get_result(): array|WP_Error {
    if ($error) {
        return new WP_Error('code', 'message');
    }
    return ['data' => $result];
}
```

### 3. Property Types (PHP 7.4+)

```php
class BbAI_Core {
    private BbAI_API_Client_V2 $api_client;
    private array $options = [];
    private ?string $token = null;
    private bool $is_authenticated = false;

    public function __construct(BbAI_API_Client_V2 $api_client) {
        $this->api_client = $api_client;
    }
}
```

---

## üèóÔ∏è v5.0 Architecture Refactoring (2-4 months)

### Phase 1: Extract Services (Week 1-2)

#### Step 1: Create Service Interfaces

**File:** `includes/interfaces/interface-generation-service.php`

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator\Interfaces;

interface Generation_Service_Interface {
    /**
     * Generate alt text for an attachment.
     *
     * @param int    $attachment_id Attachment ID.
     * @param string $source        Generation source.
     * @return string|WP_Error Generated alt text or error.
     */
    public function generate(int $attachment_id, string $source): string|\WP_Error;

    /**
     * Validate if attachment can be processed.
     *
     * @param int $attachment_id Attachment ID.
     * @return bool True if valid.
     */
    public function can_process(int $attachment_id): bool;
}
```

#### Step 2: Extract Generation Service

**File:** `includes/services/class-generation-service.php`

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator\Services;

use BeepBeepAI\AltTextGenerator\Interfaces\Generation_Service_Interface;
use BeepBeepAI\AltTextGenerator\BbAI_API_Client_V2;
use BeepBeepAI\AltTextGenerator\BbAI_Constants;

class Generation_Service implements Generation_Service_Interface {

    private BbAI_API_Client_V2 $api_client;
    private Usage_Service $usage_service;

    public function __construct(
        BbAI_API_Client_V2 $api_client,
        Usage_Service $usage_service
    ) {
        $this->api_client = $api_client;
        $this->usage_service = $usage_service;
    }

    public function generate(int $attachment_id, string $source): string|\WP_Error {
        // Validation
        if (!$this->can_process($attachment_id)) {
            return new \WP_Error(
                BbAI_Constants::ERROR_INVALID_ATTACHMENT,
                __('Invalid attachment', BbAI_Constants::TEXT_DOMAIN)
            );
        }

        // Check quota
        if (!$this->usage_service->has_credits()) {
            return new \WP_Error(
                BbAI_Constants::ERROR_QUOTA_EXCEEDED,
                __('Credit limit exceeded', BbAI_Constants::TEXT_DOMAIN)
            );
        }

        // Generate via API
        $result = $this->api_client->generate_alt_text($attachment_id);

        if (is_wp_error($result)) {
            return $result;
        }

        // Save to metadata
        update_post_meta($attachment_id, '_wp_attachment_image_alt', $result);

        // Track usage
        $this->usage_service->record_generation($attachment_id, $source);

        return $result;
    }

    public function can_process(int $attachment_id): bool {
        $post = get_post($attachment_id);

        if (!$post || 'attachment' !== $post->post_type) {
            return false;
        }

        $mime_type = get_post_mime_type($attachment_id);
        return str_starts_with($mime_type, 'image/');
    }
}
```

#### Step 3: Extract Usage Service

**File:** `includes/services/class-usage-service.php`

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator\Services;

use BeepBeepAI\AltTextGenerator\BbAI_API_Client_V2;
use BeepBeepAI\AltTextGenerator\BbAI_Constants;
use BeepBeepAI\AltTextGenerator\Credit_Usage_Logger;

class Usage_Service {

    private BbAI_API_Client_V2 $api_client;
    private array $cached_usage = [];

    public function __construct(BbAI_API_Client_V2 $api_client) {
        $this->api_client = $api_client;
    }

    public function has_credits(): bool {
        $usage = $this->get_usage();

        if (is_wp_error($usage)) {
            return false;
        }

        return $usage['remaining'] > 0;
    }

    public function get_usage(bool $force_refresh = false): array|\WP_Error {
        if (!$force_refresh && !empty($this->cached_usage)) {
            return $this->cached_usage;
        }

        $usage = $this->api_client->get_usage();

        if (!is_wp_error($usage)) {
            $this->cached_usage = $usage;
        }

        return $usage;
    }

    public function record_generation(int $attachment_id, string $source): void {
        Credit_Usage_Logger::log_generation(
            get_current_user_id(),
            $attachment_id,
            1, // credits used
            $source
        );

        // Invalidate cache
        $this->cached_usage = [];
    }

    public function get_remaining_credits(): int {
        $usage = $this->get_usage();

        if (is_wp_error($usage)) {
            return 0;
        }

        return max(0, (int) $usage['remaining']);
    }
}
```

#### Step 4: Extract AJAX Handler Service

**File:** `includes/services/class-ajax-handler-service.php`

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator\Services;

use BeepBeepAI\AltTextGenerator\BbAI_Constants;

class AJAX_Handler_Service {

    private Generation_Service $generation_service;
    private Usage_Service $usage_service;
    private Auth_Service $auth_service;

    public function __construct(
        Generation_Service $generation_service,
        Usage_Service $usage_service,
        Auth_Service $auth_service
    ) {
        $this->generation_service = $generation_service;
        $this->usage_service = $usage_service;
        $this->auth_service = $auth_service;
    }

    public function register_handlers(): void {
        add_action('wp_ajax_bbai_generate', [$this, 'handle_generate']);
        add_action('wp_ajax_bbai_login', [$this, 'handle_login']);
        add_action('wp_ajax_bbai_register', [$this, 'handle_register']);
        add_action('wp_ajax_bbai_refresh_usage', [$this, 'handle_refresh_usage']);
    }

    public function handle_generate(): void {
        check_ajax_referer(BbAI_Constants::TEXT_DOMAIN . '_nonce', 'nonce');

        $attachment_id = isset($_POST['attachment_id'])
            ? absint($_POST['attachment_id'])
            : 0;

        if ($attachment_id <= 0) {
            wp_send_json_error([
                'message' => __('Invalid attachment ID', BbAI_Constants::TEXT_DOMAIN)
            ]);
        }

        $result = $this->generation_service->generate(
            $attachment_id,
            BbAI_Constants::SOURCE_AJAX
        );

        if (is_wp_error($result)) {
            wp_send_json_error([
                'message' => $result->get_error_message(),
                'code' => $result->get_error_code()
            ]);
        }

        wp_send_json_success([
            'alt_text' => $result,
            'remaining' => $this->usage_service->get_remaining_credits()
        ]);
    }

    public function handle_login(): void {
        check_ajax_referer(BbAI_Constants::TEXT_DOMAIN . '_nonce', 'nonce');

        $email = isset($_POST['email'])
            ? sanitize_email(wp_unslash($_POST['email']))
            : '';

        $password = isset($_POST['password'])
            ? wp_unslash($_POST['password'])
            : '';

        if (empty($email) || empty($password)) {
            wp_send_json_error([
                'message' => __('Email and password required', BbAI_Constants::TEXT_DOMAIN)
            ]);
        }

        $result = $this->auth_service->login($email, $password);

        if (is_wp_error($result)) {
            wp_send_json_error([
                'message' => $result->get_error_message()
            ]);
        }

        wp_send_json_success($result);
    }

    // ... more handlers
}
```

### Phase 2: Service Container (Week 3)

**File:** `includes/class-service-container.php`

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator;

class Service_Container {

    private static ?Service_Container $instance = null;
    private array $services = [];
    private array $factories = [];

    private function __construct() {
        $this->register_core_services();
    }

    public static function instance(): Service_Container {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    private function register_core_services(): void {
        // Register API Client
        $this->register('api_client', function() {
            return new BbAI_API_Client_V2();
        });

        // Register Usage Service
        $this->register('usage_service', function() {
            return new Services\Usage_Service(
                $this->get('api_client')
            );
        });

        // Register Generation Service
        $this->register('generation_service', function() {
            return new Services\Generation_Service(
                $this->get('api_client'),
                $this->get('usage_service')
            );
        });

        // Register Auth Service
        $this->register('auth_service', function() {
            return new Services\Auth_Service(
                $this->get('api_client')
            );
        });

        // Register AJAX Handler
        $this->register('ajax_handler', function() {
            return new Services\AJAX_Handler_Service(
                $this->get('generation_service'),
                $this->get('usage_service'),
                $this->get('auth_service')
            );
        });
    }

    public function register(string $name, callable $factory): void {
        $this->factories[$name] = $factory;
    }

    public function get(string $name) {
        if (!isset($this->services[$name])) {
            if (!isset($this->factories[$name])) {
                throw new \InvalidArgumentException("Service '$name' not found");
            }

            $this->services[$name] = $this->factories[$name]();
        }

        return $this->services[$name];
    }

    public function has(string $name): bool {
        return isset($this->factories[$name]) || isset($this->services[$name]);
    }
}
```

### Phase 3: Refactored Core Class (Week 4)

**File:** `admin/class-bbai-core.php` (New slim version)

```php
<?php
declare(strict_types=1);

namespace BeepBeepAI\AltTextGenerator;

use BeepBeepAI\AltTextGenerator\Services\{
    Generation_Service,
    Usage_Service,
    AJAX_Handler_Service,
    Auth_Service
};

class BbAI_Core {

    private Service_Container $container;
    private AJAX_Handler_Service $ajax_handler;
    private Admin_UI_Service $admin_ui;

    public function __construct() {
        $this->container = Service_Container::instance();
        $this->init_services();
    }

    private function init_services(): void {
        $this->ajax_handler = $this->container->get('ajax_handler');
        $this->admin_ui = $this->container->get('admin_ui');
    }

    public function run(): void {
        $this->ajax_handler->register_handlers();
        $this->admin_ui->register_hooks();

        // Register WordPress hooks
        add_action('admin_menu', [$this, 'register_admin_menu']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_assets']);
    }

    public function register_admin_menu(): void {
        $this->admin_ui->register_menu();
    }

    public function enqueue_assets(string $hook): void {
        $this->admin_ui->enqueue_assets($hook);
    }

    // Delegate to services
    public function generate_and_save(int $attachment_id, string $source = 'manual'): string|\WP_Error {
        return $this->container
            ->get('generation_service')
            ->generate($attachment_id, $source);
    }

    public function get_usage(bool $force_refresh = false): array|\WP_Error {
        return $this->container
            ->get('usage_service')
            ->get_usage($force_refresh);
    }
}
```

---

## ‚úÖ Testing Strategy

### Unit Tests (PHPUnit)

**File:** `tests/test-generation-service.php`

```php
<?php

use BeepBeepAI\AltTextGenerator\Services\Generation_Service;
use BeepBeepAI\AltTextGenerator\BbAI_API_Client_V2;
use BeepBeepAI\AltTextGenerator\Services\Usage_Service;

class Test_Generation_Service extends WP_UnitTestCase {

    private Generation_Service $service;
    private $api_client_mock;
    private $usage_service_mock;

    public function setUp(): void {
        parent::setUp();

        $this->api_client_mock = $this->createMock(BbAI_API_Client_V2::class);
        $this->usage_service_mock = $this->createMock(Usage_Service::class);

        $this->service = new Generation_Service(
            $this->api_client_mock,
            $this->usage_service_mock
        );
    }

    public function test_generate_returns_error_for_invalid_attachment(): void {
        $result = $this->service->generate(999999, 'manual');

        $this->assertWPError($result);
        $this->assertEquals('invalid_attachment', $result->get_error_code());
    }

    public function test_generate_checks_quota_before_processing(): void {
        $attachment_id = $this->factory->attachment->create_upload_object(
            __DIR__ . '/fixtures/test-image.jpg'
        );

        $this->usage_service_mock
            ->expects($this->once())
            ->method('has_credits')
            ->willReturn(false);

        $result = $this->service->generate($attachment_id, 'manual');

        $this->assertWPError($result);
        $this->assertEquals('quota_exceeded', $result->get_error_code());
    }

    public function test_generate_success_saves_alt_text(): void {
        $attachment_id = $this->factory->attachment->create_upload_object(
            __DIR__ . '/fixtures/test-image.jpg'
        );

        $this->usage_service_mock
            ->method('has_credits')
            ->willReturn(true);

        $this->api_client_mock
            ->method('generate_alt_text')
            ->willReturn('A beautiful sunset over mountains');

        $result = $this->service->generate($attachment_id, 'manual');

        $this->assertEquals('A beautiful sunset over mountains', $result);

        $saved_alt = get_post_meta($attachment_id, '_wp_attachment_image_alt', true);
        $this->assertEquals('A beautiful sunset over mountains', $saved_alt);
    }
}
```

---

## üìã Migration Checklist

### v4.3 Checklist

- [ ] Extract constants class (‚úÖ DONE)
- [ ] Fix Yoda conditions in 5 files
- [ ] Add PHPDoc to 20+ public methods
- [ ] Add type hints to top 10 methods
- [ ] Replace magic numbers with constants
- [ ] Run all tests
- [ ] Update changelog

### v4.4 Checklist

- [ ] Add `declare(strict_types=1)` to all files
- [ ] Add type hints to all public methods
- [ ] Add type hints to all private/protected methods
- [ ] Add return type declarations
- [ ] Add property types (PHP 7.4+)
- [ ] Update PHPDoc to 80%+
- [ ] Run all tests with strict types
- [ ] Fix any type-related bugs

### v5.0 Checklist

#### Week 1-2: Extract Services
- [ ] Create service interfaces
- [ ] Extract Generation Service
- [ ] Extract Usage Service
- [ ] Extract Auth Service
- [ ] Extract AJAX Handler Service
- [ ] Extract Admin UI Service
- [ ] Extract Stripe Service
- [ ] Create unit tests for each service

#### Week 3: Service Container
- [ ] Create service container class
- [ ] Register all services
- [ ] Update dependency injection
- [ ] Test service resolution

#### Week 4: Refactor Core
- [ ] Create slim Core class
- [ ] Delegate to services
- [ ] Remove old code
- [ ] Update all references
- [ ] Run integration tests

#### Week 5-6: Testing & Polish
- [ ] Write PHPUnit tests (80% coverage)
- [ ] Integration testing
- [ ] Performance testing
- [ ] Documentation updates
- [ ] Migration guide

#### Week 7-8: Buffer & Launch
- [ ] Beta testing
- [ ] Bug fixes
- [ ] Final testing
- [ ] Release v5.0

---

## üéØ Success Metrics

### v4.3
- Documentation: 59% ‚Üí 80%
- Type hints: 22% ‚Üí 40%
- Best practices score: 66% ‚Üí 75%

### v4.4
- Type hints: 40% ‚Üí 80%
- Strict types enabled
- Best practices score: 75% ‚Üí 85%

### v5.0
- Core file: 415KB ‚Üí ~50KB
- Number of classes: 5 ‚Üí 15+
- Test coverage: 0% ‚Üí 80%
- Best practices score: 85% ‚Üí 92%
- Maintainability index: 65 ‚Üí 90

---

**This guide provides the complete roadmap from v4.3 to v5.0!** üöÄ

Use this as a reference to implement changes incrementally, test thoroughly, and release stable versions.
