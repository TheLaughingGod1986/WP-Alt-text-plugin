#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run PHP syntax check
echo "Checking PHP syntax..."
git diff --cached --name-only --diff-filter=ACM | grep '\.php$' | while read file; do
    php -l "$file"
    if [ $? -ne 0 ]; then
        echo "âŒ PHP syntax error in $file"
        exit 1
    fi
done

# Run tests
echo "Running tests..."
vendor/bin/phpunit --no-coverage --stop-on-failure
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed"
    exit 1
fi

# Build assets if changed
if git diff --cached --name-only | grep -qE 'assets/src/(js|css)'; then
    echo "Building assets..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Asset build failed"
        exit 1
    fi
    # Add built files to commit
    git add assets/dist/
fi

echo "âœ… Pre-commit checks passed"
